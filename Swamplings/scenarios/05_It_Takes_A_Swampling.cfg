#textdomain wesnoth-Swamplings

[scenario]
    id=05_It_Takes_A_Swampling
    name= _ "It Takes A Swampling"
    map_data="{~add-ons/Swamplings/maps/Archduke01.map}"
    {SCENARIO_MUSIC "into_the_shadows.ogg"}
    turns=15
    victory_when_enemies_defeated=no

    {FIRST_WATCH}

    next_scenario=06_Rogues_Reward

    [story]
        [part]
            music="calm-before-storm.ogg"
            story= _ "As tribal chieftain, I was nothing to the humans. But when they mistook me for an assassin, doors began to open for me."
            background="maps/wesnoth.png"
        [/part]
        [part]
            story= _ "I had been told to wait outside the hold of the Archduke Kennison. A signal from a sympathetic guard would tell me it was safe to enter."
            background="data/add-ons/Swamplings/images/story/fortress2_207_3.png"
        [/part]
        [part]
            story= _ "Once inside, I was expected to find and kill the Archduke."
            background="maps/wesnoth.png"
            show_title=yes
            title_alignment=center
            background="data/add-ons/Swamplings/images/story/fortress2_207_3.png"
        [/part]
    [/story]

    [side]
        type=Goblin Rouser Sw
        id=Clammie
        name=_"Clammie"
        unrenamable=yes
        x,y=45,10
        side=1
        team_name=1
        user_team_name=_"Clammie and Co."
        shroud=yes
        controller=human
        {GOLD 100 50 25}
        [modifications]
            {TRAIT_SWAMPSAVVY}
        [/modifications]
    [/side]

    [side]
        side=2
        type=South Guard Captain
        id=Phillips
        name= _ "Phillips"
        unrenamable=yes
        canrecruit=yes
        recruit=Spearman, Bowman
        team_name=2
        user_team_name=_"Archduke's Guards"
        profile="data/add-ons/Swamplings/images/portraits/transparent/gerrick_HRa.png"
        x,y=22,2
        [ai]
            ai_algorithm=idle_ai
        [/ai]
        {FLAG_VARIANT loyalist}
        {GOLD 0 0 0}
    [/side]

    # Kennison is on his own side, for now
    [side]
        no_leader=yes
        hidden=yes
        side=3
        team_name=3
        user_team_name=_"3"
        [ai]
            ai_algorithm=idle_ai
        [/ai]
        {GOLD 0 0 0}
    [/side]

    # a side that will fight
    [side]
        side=4
        [village]
            x,y=42,1
        [/village]
        [village]
            x,y=39,7
        [/village]
        [village]
            x,y=44,9
        [/village]
        [village]
            x,y=43,15
        [/village]
        [village]
            x,y=32,15
        [/village]
        [village]
            x,y=24,18
        [/village]
        color=blue
        canrecruit=yes
        recruit=Spearman, Bowman
        team_name=2
        [ai]
            passive_leader=yes
        [/ai]
        type=Master at Arms
        id=Archduke
        name= _ "Archduke"
        unrenamable=yes
        x,y=42,1
        user_team_name=_"Archduke's Guards"
        # by the time this side starts recruiting they will have plenty of gold
        {FLAG_VARIANT loyalist}
        {GOLD 50 100 150}
    [/side]

    [side]
        side=5
        no_leader=yes
        team_name=5
        user_team_name=_"Wild Things"
        [ai]
            aggression=0.9
            caution=0.0
        [/ai]
        hidden=yes
    [/side]

#ifdef YETI
    {YETI_SIDE}
#endif

    {ANIMATED_BRAZIER 39 10}

    [item]
        x,y=39,10
        image=items/brazier.png
    [/item]

    [item]
        x,y=30,2
        image=items/archery-target-right.png
    [/item]

    [item]
        x,y=31,2
        image=items/archery-target-right.png
    [/item]

    [item]
        x,y=36,2
        image=data/add-ons/Swamplings/images/items/dummy.png
    [/item]

    [item]
        x,y=29,5
        image=data/add-ons/Swamplings/images/items/bookshelf-full.png
    [/item]

    [item]
        x,y=37,15
        image=scenery/trapdoor-closed.png
    [/item]

    [event]
        name=prestart

        # real Clammie is killed for now:
        [store_unit]
            [filter]
                id=Clammie
            [/filter]
            variable=stored_clammie
        [/store_unit]

        [kill]
            id=Clammie
            animate=no
            fire_event=no
        [/kill]

        # the passage behind the corridor will be empty of guards (I was orignally going to leave it open for hard games, but it makes hard games impossible):
        ##  #ifndef HARD
        [terrain]
            x=43,44
            y=16,16
            terrain=Xos
        [/terrain]
        ## #endif

        # in hard games, enemy units are in secret passageway:
#ifdef HARD
        {GENERIC_UNIT 4 Spearman 41 18}
        {GENERIC_UNIT 4 Spearman 16 14}
#endif

        [remove_shroud]
            x,y=39,10
            radius=4
        [/remove_shroud]

        [redraw]
        [/redraw]
    [/event]

    [event]
        name=start

        [unit]
            id=Sydd
            name= _ "Sydd"
            unrenamable=yes
            type=Swordsman
            profile="portraits/humans/transparent/swordsman-2.png~RIGHT()~FL"
            x=39
            y=12
            side=2
            animate=yes
        [/unit]

        [recall]
            id=Clammie_assassin
            x=44,10
        [/recall]

        [if]
            [have_unit]
                id=Clammie_assassin
            [/have_unit]
            [else]
                {UNIT 1 (Orcish Assassin) 44 10 (
                    id=Clammie_assassin
                    name= _ "Clammie"
                    unrenamable=yes
                    canrecruit=yes
                    recruit=Vampire Bat, Goblin Spearman Sw
                    experience=$stored_clammie.experience
                    [modifications]
                        {TRAIT_SWAMPSAVVY}
                    [/modifications]
                    [abilities]
                        {ABILITY_LEADERSHIP_LEVEL_3}
                    [/abilities]
                    profile=data/add-ons/Swamplings/images/portraits/assassin.png
                )}
            [/else]
        [/if]

        {CLEAR_VARIABLE stored_clammie_assassin}

        {MOVE_UNIT id=Clammie_assassin 42 10}
        {MODIFY_UNIT id=Clammie_assassin facing sw}

        [unit]
            type=Spearman
            side=2
            x,y=21,6
            id=Lannyn
            name= _ "Lannyn"
        [/unit]

        [unit]
            type=Spearman
            side=2
            x,y=45,16
        [/unit]

        [unit]
            type=Spearman
            side=2
            x,y=45,5
        [/unit]

        [move_unit_fake]
            type=South Guard Captain
            side=2
            x=34,38
            y=14,11
        [/move_unit_fake]

        {TELEPORT_UNIT id=Phillips 38 11}

        [message]
            speaker=Phillips
            message= _ "Sydd? Report to Lannyn immediately."
        [/message]
        [message]
            speaker=Sydd
            message= _ "<i>mutters</i>"
        [/message]
        [message]
            speaker=Phillips
            message= _ "What's that, Sydd?"
        [/message]
        [message]
            speaker=Sydd
            message= _ "I said it's a fine night to be alive."
        [/message]
        [message]
            speaker=Phillips
            message= _ "I'm sure you did."
        [/message]

        # Sydd leaves
        [store_unit]
            variable=sydd_store
            kill=yes
            [filter]
                id=Sydd
            [/filter]
        [/store_unit]

        [move_unit_fake]
            type=Swordsman
            side=2
            x=39,39
            y=12,7
        [/move_unit_fake]

        # Phillips goes to brazier
	    [move_unit]
            id=Phillips
	        to_x=38
	        to_y=10
	        fire_event=no
	    [/move_unit]

        # remove nonanimated brazier. animated brazier is 'hiding' behind it (sort of).
        [remove_item]
            x,y=39,10
            image=items/brazier.png
        [/remove_item]

        [delay]
            time=750
        [/delay]

        {ITM_GLOWING_BRAZIER 39 10}

        [sound_source]
            id=brazier
            sounds=ambient/campfire.ogg
            x,y=39,10
            fade_range=2
            full_range=2
            loop=-1
        [/sound_source]

        # Phillips exits
        [store_unit]
            variable=phillips_store
            kill=yes
            [filter]
                id=Phillips
            [/filter]
        [/store_unit]

        [move_unit_fake]
            type=South Guard Captain
            side=2
            x=38,43
            y=10,15
        [/move_unit_fake]

        [objectives]
            side=1
            [objective]
                description= _ "Find the Archduke"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note= _ "Clammie is far from home and can't recruit here."+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]

        [unit]
            id=Kennison
            name= _ "Kennison"
            unrenamable=yes
#ifdef EASY
            type=Longbowman
#else
            type=Bowman
#endif
            profile=portraits/humans/transparent/duelist.png
            x=27
            y=10
            side=3
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_HERO}
        [/unit]

        {VARIABLE chapter 1}

        # prevent Clammie_assassin from recruiting:
        [disallow_recruit]
            type=Goblin Spearman Sw, Vampire Bat
        [/disallow_recruit]
    [/event]

    [event]
        name=turn 1
        [message]
            speaker=Clammie_assassin
            message= _ "Well, it's hard to mistake that signal. I see a figure to the northwest. I wonder if that's the Archduke."
        [/message]
    [/event]

    # if Clammie attacks spearmen, they vanish
    [event]
        name=attack
        [filter_second]
            type=Spearman
        [/filter_second]
        [if]
            [variable]
                name=chapter
                equals=1
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "When you approach, the guard gives you a sly wink and steps into a nearby hallway."
                [/message]
                [store_unit]
                    [filter]
                        type=Spearman
                    [/filter]
                    variable=starting_spearmen
                    kill=yes
                [/store_unit]
                {VARIABLE guards_are_gone yes}
            [/then]
        [/if]
    [/event]

    # Clammie meets the quintain
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Clammie_assassin
            x=35-37
            y=2-3
        [/filter]
        [if]
            [variable]
                name=chapter
                equals=1
            [/variable]
            [then]
                [message]
                    speaker=Clammie_assassin
                    message= _ "Speak not! I know who you are and your fate is in my hands."
                [/message]
                [message]
                    caption=_"Quintain"
                    message= _ "--"
                    image=data/add-ons/Swamplings/images/items/dummy.png
                [/message]
                [message]
                    speaker=Clammie_assassin
                    message= _ "No doubt you are frightened by my visage, but I am not as I appear. I was sent here by the human who killed my son. He has escaped my wrath for the moment, but the day will come when I shall repay his perfidy. He is the knight they call Shining. Surely you know him?"
                [/message]
                [message]
                    caption=_"Quintain"
                    message= _ "--"
                    image=data/add-ons/Swamplings/images/items/dummy.png
                [/message]
                [message]
                    speaker=Clammie_assassin
                    message= _ "Judging by your complete lack of speech or movement, coupled by the fact that you smell strongly of sawdust, I deduce that further conversation with you is pointless. Good night."
                [/message]
            [/then]
        [/if]
    [/event]

    # Clammie meets Kennison:
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Clammie_assassin
            x=26,26,27,27,28,28
            y= 9,10, 9,11, 9,10
        [/filter]

        # face Clammie toward Kennison
        [animate_unit]
            flag=victory
            [filter]
                id=Clammie_assassin
            [/filter]
            [facing]
                [filter]
                    id=Kennison
                [/filter]
            [/facing]
        [/animate_unit]

        # face Kennison toward Clammie
        [animate_unit]
            flag=victory
            [filter]
                id=Kennison
            [/filter]
            [facing]
                [filter]
                    id=Clammie_assassin
                [/filter]
            [/facing]
        [/animate_unit]

        [scroll_to_unit]
            id=Clammie_assassin
        [/scroll_to_unit]

        [message]
            speaker=Kennison
            message= _ "Who are you?"
        [/message]
        [message]
            speaker=Clammie_assassin
            message= _ "My name is irrelevant. I have come to warn you--"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Of the Westford Irrelevants? A fine family, that!"
        [/message]
        [message]
            speaker=Clammie_assassin
            message= _ "You're very kind, Duke."
        [/message]
        [message]
            speaker=Kennison
            message= _ "<i>Arch</i> duke!"
        [/message]
        [message]
            speaker=Clammie_assassin
            message= _ "Sir, I want to warn you that the shining knight wants you assassinated!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Assassinated? There hasn't been skullduggery like that for generations!"
        [/message]
        [message]
            speaker=Clammie_assassin
            message= _ "Not so! Shining had that other guy snuffed too! Lord Prawnball."
        [/message]
        [message]
            speaker=Kennison
            message= _ "Lord Cornwell? My dear chap, Cornwell died of a fever."
        [/message]
        [message]
            speaker=Clammie_assassin
            message= _ "A fever brought on by poison!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "How am I to believe you? Remove that mask and let me see your face!"
        [/message]
        [message]
            speaker=Clammie_assassin
            message= _ "As you wish."
        [/message]

        [unstore_unit]
            variable=stored_clammie
            find_vacant=yes
        [/unstore_unit]

        {STORE_UNIT_VAR id=Clammie_assassin x Clammie_assassin_x}
        {STORE_UNIT_VAR id=Clammie_assassin y Clammie_assassin_y}

        [kill]
            id=Clammie_assassin
            animate=no
            fire_event=no
        [/kill]

        {TELEPORT_UNIT id=Clammie $Clammie_assassin_x $Clammie_assassin_y}

        {ADVANCE_UNIT id=Clammie $clammie_type}

        {CLEAR_VARIABLE Clammie_assassin_x,Clammie_assassin_y,clammie_type,stored_clammie}

        # store Clammie to fix his experience:
        [store_unit]
            [filter]
                id=Clammie
            [/filter]
            variable=clammie_store
        [/store_unit]

        {VARIABLE clammie_store.experience $clammie_experience}

        [unstore_unit]
            variable=clammie_store
        [/unstore_unit]

        # face Clammie toward Kennison:
        [animate_unit]
            flag=victory
            [filter]
                id=Clammie
            [/filter]
            [facing]
                [filter]
                    id=Kennison
                [/filter]
            [/facing]
        [/animate_unit]

        [message]
            speaker=Kennison
            message= _ "My word! You're a dwarf!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "A swamp goblin in fact, but that does not matter."
        [/message]
        [message]
            speaker=Kennison
            message= _ "How dare you impersonate one of the fine family of Irrelevant?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "You idiot, I was impersonating your assassin!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Well sir, I may be an idiot, but for an assassin you've done an execrable job!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Perhaps I am not making myself clear--"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Perhaps nothing! You've botched this job from the start! Now either you must kill me immediately, or I shall call for my guards and they shall kill you!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "I'm beginning to wonder … are you really the Archduke?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "All right, I suppose the intrigue has become a bit convoluted. The Archduke and I had a little wager. He suspected an assassin would be sent here. I told him I believe in the basic honesty and integrity of any man, and assured him I could reason with any assassin. The Archduke chose to take an extended holiday at his summer villa."
        [/message]
        [message]
            speaker=Clammie
            message= _ "So he believes in the basic dishonesty and ruthlessness of his fellow man."
        [/message]
        [message]
            speaker=Kennison
            message= _ "Quite bright for a swamp goblin."
        [/message]
        [message]
            speaker=Clammie
            message= _ "So we are both impostors?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "The only difference is, I aspire to impersonate above my station and you stoop to impersonate beneath yours."
        [/message]
        [message]
            speaker=Clammie
            message= _ "If you're not Kennison, what's your real name?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Kennison. I'm the Archduke's uncle, and in his mind, totally expendable."
        [/message]

        # Clammie must move if he's on the same hex as Phillips will take, otherwise the later attack animation looks really strange!
        {IF_VAR clammie_store.x equals 26 (
            [then]
                {IF_VAR clammie_store.y equals 10 (
                    [then]
                        {MOVE_UNIT id=Clammie 26 9}
                        #TODO if Trumpeter gets a south facing frame, change to south:
                        {MODIFY_UNIT id=Clammie facing se}
                    [/then]
                )}
            [/then]
        )}

        # enter Phillips
        [move_unit_fake]
            type=South Guard Captain
            side=2
            x=28,26
            y=14,10
        [/move_unit_fake]
        [unstore_unit]
            variable=phillips_store
            x,y=26,10
            find_vacant=yes
        [/unstore_unit]

        [message]
            speaker=Phillips
            message= _ "Excuse me, the men and I have been wondering what's taking so long?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Please be patient … my assassin and I are nearing an agreement."
        [/message]
        [message]
            speaker=Phillips
            message= _ "Well, we need at least one dead body in here if we're to spread the rumor of the Archduke's assassination. So which of you will take the job? Ye gods! He's a troll!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "You really must study your bestiary, Phillips!"
        [/message]
        [message]
            speaker=Phillips
            message= _ "We can't pass a troll corpse off as the Archduke!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Why are you looking at me that way, Phillips? Do you think I will not defend myself?"
        [/message]

        #Kennison attacks Phillips.
        [animate_unit]
            flag=attack
            with_bars=no
            [filter]
                id=Kennison
            [/filter]
            [primary_attack]
                name=bow
            [/primary_attack]
            hits=yes
            [facing]
                [filter]
                    id=Phillips
                [/filter]
            [/facing]
            [animate]
                flag=defend
                [filter_second]
                    id=Phillips
                [/filter_second]
                hits=yes
                with_bars=no
                [facing]
                    [filter]
                        id=Kennison
                    [/filter]
                [/facing]
            [/animate]
        [/animate_unit]

        #Kennison attacks Phillips.
        [animate_unit]
            flag=attack
            with_bars=no
            [filter]
                id=Kennison
            [/filter]
            [primary_attack]
                name=bow
            [/primary_attack]
            hits=yes
            [facing]
                [filter]
                    id=Phillips
                [/filter]
            [/facing]
            [animate]
                flag=defend
                [filter_second]
                    id=Phillips
                [/filter_second]
                hits=yes
                with_bars=no
                [facing]
                    [filter]
                        id=Kennison
                    [/filter]
                [/facing]
            [/animate]
        [/animate_unit]

        # Phillips is injured
        [store_unit]
            [filter]
                id=Phillips
            [/filter]

            variable=phillips_store
        [/store_unit]

        {VARIABLE_OP phillips_store.hitpoints add -10}

        [unstore_unit]
            variable=phillips_store
            find_vacant=no
            text=_"10"
            {COLOR_HARM}
        [/unstore_unit]

        [redraw]
        [/redraw]

        [sound]
            name=human-hit-2.ogg
        [/sound]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Phillips
            # he previously said, "By Haldric's onions!" but Haldric hasn't been born yet.
            message= _ "Miscreant! I've been meaning to patch it there!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Poor form, Phillips!"
        [/message]

        # Phillips counterattacks
        [animate_unit]
            flag=attack
            with_bars=no
            [filter]
                id=Phillips
            [/filter]
            [primary_attack]
                name=glaive
            [/primary_attack]
            hits=no
            [facing]
                [filter]
                    id=Kennison
                [/filter]
            [/facing]
            [animate]
                flag=defend
                [filter_second]
                    id=Kennison
                [/filter_second]
                hits=no
                with_bars=no
                [facing]
                    [filter]
                        id=Phillips
                    [/filter]
                [/facing]
            [/animate]
        [/animate_unit]

        [message]
            speaker=Kennison
            message= _ "Methinks you've been skipping your practice time with friend quintain, Phillips!"
        [/message]
        [message]
            speaker=Phillips
            message= _ "INTRUDERS!"
        [/message]

        {REPLACE_SCENARIO_MUSIC "data/add-ons/Swamplings/music/desert_chase.ogg"}
        {APPEND_MUSIC frantic.ogg}

        # Phillips moves to keep
        [store_unit]
            variable=phillips_store
            kill=yes
            [filter]
                id=Phillips
            [/filter]
        [/store_unit]
        [move_unit_fake]
            type=South Guard Captain
            side=2
            x=26,32
            y=10,10
        [/move_unit_fake]
        [unstore_unit]
            variable=phillips_store
            x,y=32,10
        [/unstore_unit]

        # in yeti, normal & hard games, Sydd returns
#ifndef EASY
        [unstore_unit]
            variable=sydd_store
            x,y=38,7
            resting=no
        [/unstore_unit]
#endif

        # if guards are gone, they return:
        [if]
            [variable]
                name=guards_are_gone
                equals=yes
            [/variable]
            [then]
                {FOREACH starting_spearmen i}
                    [unstore_unit]
                        variable=starting_spearmen[$i]
                        find_vacant=yes
                    [/unstore_unit]
                {NEXT i}
            [/then]
        [/if]

        # change all side 2 units to side 4, because side 2's ai_algorithm seems to be stuck on stupid (either that, or I am).
        {MODIFY_UNIT side=2 side 4}

        # wake up any spearmen that are still resting:
        {MODIFY_UNIT type=Spearman resting no}

        # side 2 no longer appears in status table
        [modify_side]
            side=2
            hidden=true
        [/modify_side]

        {MODIFY_UNIT id=Kennison side 1}

        # give Clammie some moves.
        {MODIFY_UNIT id=Clammie moves 5}

        # simulated recruitment:
        {UNIT 4 Spearman 28 6 animate=yes}
        {UNIT 4 Bowman 29 7 animate=yes}
        {UNIT 4 Spearman 30 7 animate=yes}
        {UNIT 4 Bowman 31 8 animate=yes}
        {UNIT 4 Spearman 32 8 animate=yes}

        [message]
            speaker=Phillips
            message= _ "Sydd! Close the drawbridge!"
        [/message]
        [message]
            speaker=Sydd
            message= _ "<i>mutters</i>"
        [/message]

        # close drawbridge:
        [terrain]
            x,y=40,9
            terrain=Wo
        [/terrain]

        [redraw]
        [/redraw]

        [scroll_to_unit]
            id=Clammie
        [/scroll_to_unit]

        [message]
            speaker=Clammie
            message= _ "Kennison? Is there a back door to this cottage?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Not exactly ... but let me take you on a tour of the grounds. We'll begin with the path to our south."
        [/message]

        [objectives]
            summary= _ "New Objectives:"
            side=1
            [objective]
                description= _ "Escape"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
            note= _ "Hint: You're seriously outnumbered! Run!"+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]

        {VARIABLE chapter 2}

        # add 40 more turns to turn limit:
        {VARIABLE turns 40}
        {VARIABLE_OP turns add $turn_number}

        [modify_turns]
            value=$turns
        [/modify_turns]

        # make Clammie slippery awhile
        {FORCE_CHANCE_TO_HIT side=4 id="Clammie" 0 (
            [variable]
                name=turn_number
                less_than=6
            [/variable]
        )}

#ifdef YETI
        {YETI_SPAWN}
        {TELEPORT_UNIT id=Yeti 34 9}
#endif
    [/event]

    # Clammie at trapdoor
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Clammie
            x=37
            y=15
        [/filter]
        [if]
            [variable]
                name=chapter
                equals=2
            [/variable]
            [then]
                [if]
                    [variable]
                        name=hesaidthis
                        not_equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Clammie
                            message= _ "Locked!"
                        [/message]
                        [message]
                            speaker=Kennison
                            message= _ "That merely leads to the drainage system. The Archduke's plumbing is the talk of the town."
                        [/message]
                        [message]
                            speaker=Clammie
                            message= _ "I was hoping to find a spot that might be a bit less hazardous."
                        [/message]
                        [message]
                            speaker=Kennison
                            message= _ "Ah well, let's adjourn to the main hall, I do all my best thinking there."
                        [/message]
                        [message]
                            speaker=Clammie
                            message= _ "Fine. How do we get past all the humans trying to kill us?"
                        [/message]
                        [message]
                            speaker=Kennison
                            message= _ "By means of the torch, of course."
                        [/message]

                        {VARIABLE hesaidthis yes}
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    # Torch 1:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Clammie
            x,y=39,15
            [or]
                id=Kennison
                x,y=39,15
            [/or]
        [/filter]

        {IF_VAR sp_1_open not_equals yes (
            [then]
                [terrain]
                    x,y=41,16
                    terrain=Iwr
                [/terrain]

                [terrain]
                    x=43,44
                    y=16,16
                    terrain=Xos
                [/terrain]

                [sound]
                    name=wose-miss.ogg
                [/sound]

                [redraw]
                [/redraw]

                [if]
                    [variable]
                        name=ksaidthis1
                        not_equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Kennison
                            message= _ "Our tour continues. After you, if you please."
                        [/message]

                        {VARIABLE ksaidthis1 yes}
                    [/then]
                [/if]

                {VARIABLE sp_1_open yes}
            [/then]
            [else]
                [terrain]
                    x,y=41,16
                    terrain=Xos
                [/terrain]

#ifdef HARD
                [terrain]
                    x=43,44
                    y=16,16
                    terrain=Ch
                [/terrain]
#endif

                [sound]
                    name=wose-miss.ogg
                [/sound]

                [redraw]
                [/redraw]

                {VARIABLE sp_1_open foo}

                # any unit caught in closing passageway is pushed:
                [if]
                    [have_unit]
                        x,y=41,16
                    [/have_unit]

                    [then]
                        [store_unit]
                            [filter]
                                x,y=41,16
                            [/filter]

                            variable=in_wall
                        [/store_unit]

                        {MOVE_UNIT id=$in_wall.id 40 15}
                        {CLEAR_VARIABLE in_wall}
                    [/then]
                [/if]
            [/else]
        )}

        [allow_undo]
        [/allow_undo]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Kennison
            x=16-20
            y=13-16
        [/filter]

        {MOVE_UNIT id=Kennison 16 14}
        {MOVE_UNIT id=Clammie 17 15}
        {MODIFY_UNIT id=Clammie facing nw}

        [remove_shroud]
            x,y=16,14
            radius=5
        [/remove_shroud]

        [scroll_to_unit]
            id=Clammie
        [/scroll_to_unit]

        [message]
            speaker=Clammie
            message= _ "What's this? A pond in the main hall?"
        [/message]

        {MODIFY_UNIT id=Kennison facing se}

        [message]
            speaker=Kennison
            message= _ "The roofing shingles shall be imported from a great craftsman in the far east. These things take time."
        [/message]

        {MODIFY_UNIT id=Kennison facing nw}

        [message]
            speaker=Clammie
            message= _ "They’re right behind us! What are you doing with that rope?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Attaching it to this arrow, so I can aim it up at that large beam."
        [/message]

        [sound]
            name=bow.ogg
        [/sound]

        [message]
            speaker=Clammie
            message= _ "An impressive trick, but somewhat tangential to our immediate predicament."
        [/message]
        [message]
            speaker=Kennison
            message= _ "My friend, one goblin’s tangent is another man’s axis."
        [/message]

        [store_unit]
            [filter]
                id=Kennison
            [/filter]

            variable=kennison_store
            kill=yes
        [/store_unit]

        [sound]
            name=sling-miss.ogg
        [/sound]

        [move_unit_fake]
            type=$kennison_store.type
            side=1
            x=15,14
            y=14,13
        [/move_unit_fake]

        [unstore_unit]
            variable=kennison_store
            find_vacant=no
            x,y=14,13
        [/unstore_unit]

        [scroll_to_unit]
            id=Kennison
        [/scroll_to_unit]

        [item]
            x,y=16,14
            image=data/add-ons/Swamplings/images/items/rope.png
        [/item]

        [redraw]
        [/redraw]

        {MOVE_UNIT id=Kennison 13 14}
        {MODIFY_UNIT id=Kennison facing se}

        [message]
            speaker=Kennison
            message= _ "Your turn! Hurry!"
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Clammie
            x,y=16,14
        [/filter]

        [remove_item]
            x,y=16,14
            image=data/add-ons/Swamplings/images/items/rope.png
        [/remove_item]

        [store_unit]
            [filter]
                id=Clammie
            [/filter]

            variable=stored_clammie
            kill=yes
        [/store_unit]

        [unit]
            x,y=16,14
            type=Swinging
            name=Clammie
            id=Clammie
            side=1
            profile=$stored_clammie.profile
            experience=$stored_clammie.experience
            level=$stored_clammie.level
            moves=$stored_clammie.moves
            max_moves=$stored_clammie.max_moves
            hitpoints=$stored_clammie.hitpoints
            max_hitpoints=$stored_clammie.max_hitpoints
            canrecruit=yes
            facing=sw
            [modifications]
                {TRAIT_SWAMPSAVVY}
            [/modifications]
            [abilities]
                {ABILITY_LEADERSHIP_LEVEL_3}
            [/abilities]
        [/unit]

        [redraw]
        [/redraw]

        [message]
            speaker=Clammie
            message= _ "Like this?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "No! You've got it completely wrong! You must--"
        [/message]

        [kill]
            x,y=16,14
            animate=no
            fire_event=no
        [/kill]

        [move_unit_fake]
            type=Swinging
            side=1
            x=15,14
            y=14,13
        [/move_unit_fake]

        [sound]
            name=sling-miss.ogg
        [/sound]

        [move_unit_fake]
            type=Swinging
            side=1
            x=15,16
            y=13,12
        [/move_unit_fake]

        [sound]
            name=goblin-hit-3.ogg
        [/sound]

        [move_unit_fake]
            type=Swinging
            side=1
            x=15,14
            y=13,13
        [/move_unit_fake]

        [sound]
            name=water-blast.wav
        [/sound]

        [move_unit_fake]
            type=Swinging
            side=1
            x=15,15,16,15,15,14
            y=14,15,15,15,14,13
        [/move_unit_fake]

        [sound]
            name=goblin-hit-3.ogg
        [/sound]

        [unstore_unit]
            variable=stored_clammie
            find_vacant=no
            x,y=14,13
        [/unstore_unit]

        [redraw]
        [/redraw]

        {CLEAR_VARIABLE stored_clammie}

        [scroll_to_unit]
            id=Clammie
        [/scroll_to_unit]

        [message]
            speaker=Kennison
            message= _ "Yes, good show."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Clammie
            x=5-12
            y=1-3
            [or]
                id=Kennison
                x=5-12
                y=1-3
            [/or]
        [/filter]

        [message]
            speaker=Kennison
            message= _ "WAIT!"
        [/message]

        {MOVE_UNIT id=Kennison 5 1}
        {MODIFY_UNIT id=Kennison facing se}
        {MOVE_UNIT id=Clammie 6 1}
        {MODIFY_UNIT id=Clammie facing nw}

        [remove_shroud]
            x=1-7
            y=1-13
            radius=3
        [/remove_shroud]

        # shroud seems to stick by columns here, so this extra is necessary:
        [remove_shroud]
            x,y=1,13
            radius=2
        [/remove_shroud]
        [remove_shroud]
            x,y=1,11
            radius=2
        [/remove_shroud]
        [remove_shroud]
            x,y=1,9
            radius=2
        [/remove_shroud]
        [remove_shroud]
            x,y=1,6
            radius=2
        [/remove_shroud]

        [redraw]
        [/redraw]

        [message]
            speaker=Kennison
            message= _ "Many of the columns here are unfinished! You could get hit with a loose stone if you're not careful! Walk this way."
        [/message]

        {MODIFY_UNIT id=Clammie facing sw}

        [store_unit]
            [filter]
                id=Kennison
            [/filter]

            variable=kennison_store
            kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$kennison_store.type
            side=1
            x=5,3,2,2,5,5,2,1,3,4,6,5,2,1
            y=1,2,3,4,5,6,6,9,9,7,9,11,10,13
        [/move_unit_fake]

        [unstore_unit]
            variable=kennison_store
            find_vacant=no
            x,y=1,13
        [/unstore_unit]

        [redraw]
        [/redraw]

        [scroll_to_unit]
            id=Kennison
        [/scroll_to_unit]

        [message]
            speaker=Kennison
            message= _ "Quite simple, actually."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Could you please show me that again?"
        [/message]

        [kill]
            x,y=1,13
            animate=no
            fire_event=no
        [/kill]

        [move_unit_fake]
            type=$kennison_store.type
            side=1
            x=1,2,5,6,4,3,1,2,5,5,2,2,3
            y=13,10,11,9,7,9,9,6,6,5,4,3,2
        [/move_unit_fake]

        [unstore_unit]
            variable=kennison_store
            find_vacant=no
            x,y=3,2
        [/unstore_unit]

        [redraw]
        [/redraw]

        [scroll_to_unit]
            id=Kennison
        [/scroll_to_unit]

        [message]
            speaker=Kennison
            message= _ "Please hurry! We're rather outnumbered, you know."
        [/message]

        [kill]
            x,y=3,2
            animate=no
            fire_event=no
        [/kill]

        [move_unit_fake]
            type=$kennison_store.type
            side=1
            x=3,2,2,5,5,2,1,3,4,6,5,3
            y=2,3,4,5,6,6,9,9,7,9,11,12
        [/move_unit_fake]

        # Kennison is injured
        {VARIABLE_OP kennison_store.hitpoints add -5}

        [sound]
            name=staff.wav
        [/sound]

        [unstore_unit]
            variable=kennison_store
            find_vacant=no
            text=_"5"
            {COLOR_HARM}
            x,y=3,12
        [/unstore_unit]

        [redraw]
        [/redraw]

        {CLEAR_VARIABLE kennison_store}

        [scroll_to_unit]
            id=Kennison
        [/scroll_to_unit]

        [message]
            speaker=Kennison
            message= _ "Perhaps it is a bit knotty!"
        [/message]
    [/event]

    # north chamber traps:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=2,1,1,4,5,6,1,1,6,4,3
            y=1,2,3,3,3,3,5,6,4,9,12
        [/filter]

        {VARIABLE_OP unit.hitpoints add -5}

        [sound]
            name=staff.wav
        [/sound]

        [unstore_unit]
            variable=unit
            find_vacant=no
            text=_"5"
            {COLOR_HARM}
        [/unstore_unit]

        [redraw]
        [/redraw]

        # in the unlikely event that a unit goes below 0 hp, they die:

        {IF_VAR unit.hitpoints less_than_equal_to 0 (
            [then]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=casualties
                    mode=append
                [/store_unit]
            [/then]
        )}

        {FOREACH casualties i}
            [kill]
                x,y=$casualties[$i].x,$casualties[$i].y
                animate=yes
                fire_event=yes
            [/kill]
        {NEXT i}

        {CLEAR_VARIABLE casualties}
    [/event]

    # in case Kennison moves to torch #2 (also to open and close this passage):
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=7,17
        [/filter]

        {IF_VAR sp_2_open not_equals yes (
            [then]
                [terrain]
                    x,y=4,14
                    terrain=Rr
                [/terrain]

                [terrain]
                    x=1,2
                    y=13,13
                    terrain=Xos
                [/terrain]

                [sound]
                    name=wose-miss.ogg
                [/sound]

                [redraw]
                [/redraw]

                # any unit caught in closing passageway is pushed:
                [if]
                    [have_unit]
                        x,y=1,13
                    [/have_unit]

                    [then]
                        [store_unit]
                            [filter]
                                x,y=1,13
                            [/filter]

                            variable=in_wall
                        [/store_unit]

                        {MOVE_UNIT id=$in_wall.id 1 12}
                        {CLEAR_VARIABLE in_wall}
                    [/then]
                [/if]

                [if]
                    [have_unit]
                        x,y=2,13
                    [/have_unit]

                    [then]
                        [store_unit]
                            [filter]
                                x,y=2,13
                            [/filter]

                            variable=in_wall
                        [/store_unit]

                        {MOVE_UNIT id=$in_wall.id 2 12}
                        {CLEAR_VARIABLE in_wall}
                    [/then]
                [/if]

                [if]
                    [variable]
                        name=ksaidthis
                        not_equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Kennison
                            message= _ "Egad!"
                        [/message]

                        {VARIABLE ksaidthis yes}
                    [/then]
                [/if]

                {VARIABLE sp_2_open yes}
            [/then]
            [else]
                [terrain]
                    x,y=4,14
                    terrain=Xos
                [/terrain]

                [terrain]
                    x=1,2
                    y=13,13
                    terrain=Rr
                [/terrain]

                [sound]
                    name=wose-miss.ogg
                [/sound]

                [redraw]
                [/redraw]

                {VARIABLE sp_2_open foo}

                # any unit caught in closing passageway is pushed:
                [if]
                    [have_unit]
                        x,y=4,14
                    [/have_unit]

                    [then]
                        [store_unit]
                            [filter]
                                x,y=4,14
                            [/filter]

                            variable=in_wall
                        [/store_unit]

                        {MOVE_UNIT id=$in_wall.id 4 15}
                        {CLEAR_VARIABLE in_wall}
                    [/then]
                [/if]
            [/else]
        )}

        [allow_undo]
        [/allow_undo]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Clammie
            x=3-10
            y=15-18
            [not]
                x= 7, 8, 9,10, 9,10
                y=15,15,15,15,16,16
            [/not]
        [/filter]

        [message]
            speaker=Clammie
            message= _ "Another torch! What does this one do?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "It lights the hallway."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Ohh."
        [/message]
        [message]
            speaker=Kennison
            message= _ "And ..."
        [/message]

        {MOVE_UNIT id=Kennison 7 17}

        [scroll_to]
            x,y=4,14
        [/scroll_to]

        [terrain]
            x,y=4,14
            terrain=Rr
        [/terrain]

        [terrain]
            x=1,2
            y=13,13
            terrain=Xos
        [/terrain]

        [sound]
            name=wose-miss.ogg
        [/sound]

        [redraw]
        [/redraw]

        # any unit caught in closing passageway is pushed:
        [if]
            [have_unit]
                x,y=1,13
            [/have_unit]

            [then]
                [store_unit]
                    [filter]
                        x,y=1,13
                    [/filter]

                    variable=in_wall
                [/store_unit]

                {MOVE_UNIT id=$in_wall.id 1 12}
                {CLEAR_VARIABLE in_wall}
            [/then]
        [/if]

        [if]
            [have_unit]
                x,y=2,13
            [/have_unit]

            [then]
                [store_unit]
                    [filter]
                        x,y=2,13
                    [/filter]

                    variable=in_wall
                [/store_unit]

                {MOVE_UNIT id=$in_wall.id 2 12}
                {CLEAR_VARIABLE in_wall}
            [/then]
        [/if]

        {VARIABLE sp_2_open yes}

        [message]
            speaker=Kennison
            message= _ "A bit underhanded of us, but these blighters don't seem satisfied with any of the corpses we've given them ... do you think they're after the family resemblance?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "What are our chances of getting that drawbridge open?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "On my life, I've never made sense of that fiddly thing. All those chains and pulleys, it's frightfully complex. We'd do better to swim the moat, although the bowmen would cover our backs with bodkin points!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "We'll break the lock off that trap door and escape through the drain."
        [/message]
        [message]
            speaker=Kennison
            message= _ "This cloak could use a bit of a soak. Lead on!"
        [/message]

        {VARIABLE chapter 3}

        # add 20 more turns to turn limit:
        {VARIABLE turns 20}
        {VARIABLE_OP turns add $turn_number}

        [modify_turns]
            value=$turns
        [/modify_turns]

        {HIGHLIGHT_IMAGE 37 15 scenery/trapdoor-closed.png ()}

        [objectives]
            summary= _ "New Objectives:"
            side=1
            [objective]
                description= _ "Move Clammie to the trap door"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note={NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]
    [/event]

    # unshroud south chamber when nearby village is entered:
    [event]
        name=moveto
        [filter]
            x,y=10,18
        [/filter]
        [remove_shroud]
            x,y=16,21
            radius=1
        [/remove_shroud]
        [remove_shroud]
            x=1-12
            y=19-32
            radius=1
        [/remove_shroud]
        [remove_shroud]
            x=13-16
            y=22-32
            radius=1
        [/remove_shroud]
        [remove_shroud]
            x=17-18
            y=24-32
            radius=1
        [/remove_shroud]
    [/event]

    # south chamber traps:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x= 6, 7, 8, 1-12,1-18
            y=19,19,19,20-22,23-32
        [/filter]

        {VARIABLE_OP unit.hitpoints add -5}

        [sound]
            name=staff.wav
        [/sound]

        [unstore_unit]
            variable=unit
            find_vacant=no
            text=_"5"
            {COLOR_HARM}
        [/unstore_unit]

        [redraw]
        [/redraw]

        # if a unit goes below 0 hp, they die:
        {IF_VAR unit.hitpoints less_than_equal_to 0 (
            [then]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=casualties
                    mode=append
                [/store_unit]
            [/then]
        )}

        {FOREACH casualties i}
            [kill]
                x,y=$casualties[$i].x,$casualties[$i].y
                animate=yes
                fire_event=yes
            [/kill]
        {NEXT i}

        {CLEAR_VARIABLE casualties}
    [/event]

    # secret passage #3:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Clammie
            x,y=16,21
            [or]
                id=Kennison
                x,y=16,21
            [/or]
        [/filter]

        {IF_VAR sp_3_open not_equals yes (
            [then]
                [terrain]
                    x=9,9
                    y=18,19
                    terrain=Xos
                [/terrain]

                [terrain]
                    x,y=19,22
                    terrain=Rr
                [/terrain]

                [sound]
                    name=wose-miss.ogg
                [/sound]

                [redraw]
                [/redraw]

                {VARIABLE sp_3_open yes}

                # any unit caught in closing passageway is pushed:
                [if]
                    [have_unit]
                        x,y=9,19
                    [/have_unit]

                    [then]
                        [store_unit]
                            [filter]
                                x,y=9,19
                            [/filter]

                            variable=in_wall
                        [/store_unit]

                        {MOVE_UNIT id=$in_wall.id 8 18}
                        {CLEAR_VARIABLE in_wall}
                    [/then]
                [/if]

                [if]
                    [have_unit]
                        x,y=9,18
                    [/have_unit]

                    [then]
                        [store_unit]
                            [filter]
                                x,y=9,18
                            [/filter]

                            variable=in_wall
                        [/store_unit]

                        {MOVE_UNIT id=$in_wall.id 8 17}
                        {CLEAR_VARIABLE in_wall}
                    [/then]
                [/if]
            [/then]
            [else]
                [terrain]
                    x,y=9,18
                    terrain=Rr
                [/terrain]

                [terrain]
                    x,y=19,22
                    terrain=Xos
                [/terrain]

                [sound]
                    name=wose-miss.ogg
                [/sound]

                [redraw]
                [/redraw]

                {VARIABLE sp_3_open foo}

                # any unit caught in closing passageway is pushed:
                [if]
                    [have_unit]
                        x,y=19,22
                    [/have_unit]

                    [then]
                        [store_unit]
                            [filter]
                                x,y=19,22
                            [/filter]

                            variable=in_wall
                        [/store_unit]

                        {MOVE_UNIT id=$in_wall.id 18 22}
                        {CLEAR_VARIABLE in_wall}
                    [/then]
                [/if]
            [/else]
        )}

        [allow_undo]
        [/allow_undo]
    [/event]

    # Clammie at trapdoor chapt 3
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Clammie
            x=37
            y=15
        [/filter]
        [if]
            [variable]
                name=chapter
                equals=3
            [/variable]
            [then]
                # remove icon
                [remove_item]
                    x,y=37,15
                    image=scenery/trapdoor-closed.png
                [/remove_item]
                [sound]
                    name=fist.ogg
                [/sound]
                [item]
                    x,y=37,15
                    image=scenery/trapdoor-open.png
                [/item]

                {TELEPORT_UNIT (id=Clammie) 37 26}

                [remove_shroud]
                    x,y=37,26
                    radius=2
                [/remove_shroud]

                [remove_item]
                    x,y=39,10
                    image=items/brazier-lit1.png
                    halo=halo/fire-aura
                [/remove_item]

                [scroll_to_unit]
                    id=Clammie
                [/scroll_to_unit]

                {COLOR_ADJUST 0 25 0}

                [sound]
                    name=water-blast.wav
                [/sound]

                [message]
                    speaker=Clammie
                    message= _ "So this is what they call plumbing. Kennison, where are you?"
                [/message]

                {COLOR_ADJUST 0 0 0}

                [scroll_to_unit]
                    id=Kennison
                [/scroll_to_unit]

                [message]
                    speaker=Kennison
                    message= _ "On your heels, brave sir!"
                [/message]

                {MOVE_UNIT id=Kennison 37 15}
                {TELEPORT_UNIT id=Kennison 36 25}
                {COLOR_ADJUST 0 25 0}

                [sound]
                    name=water-blast.wav
                [/sound]

                [place_shroud]
                    x=1-45
                    y=1-21
                    radius=2
                [/place_shroud]

                #	[place_shroud]
                #		x=1-19
                #		y=21-32
                #	[/place_shroud]

                {REPLACE_SCENARIO_MUSIC into_the_shadows.ogg}
                {APPEND_MUSIC underground.ogg}

                [scroll_to_unit]
                    id=Kennison
                [/scroll_to_unit]

                [message]
                    speaker=Kennison
                    message= _ "Fascinating. I always thought there was a ladder."
                [/message]
                [message]
                    speaker=Clammie
                    message= _ "Do you think they'll follow us down here?"
                [/message]
                [message]
                    speaker=Kennison
                    message= _ "Unlikely. I've seen their wages."
                [/message]
                [message]
                    speaker=Clammie
                    message= _ "Which way to the egress?"
                [/message]
                [message]
                    speaker=Kennison
                    message= _ "Yearning for the bogs, my friend? The way out should be due east."
                [/message]

                [remove_shroud]
                    x,y=45,25
                    radius=2
                [/remove_shroud]

                {HIGHLIGHT_IMAGE 45 25 items/gohere.png ()}

                [scroll_to_unit]
                    id=Clammie
                [/scroll_to_unit]

                [objectives]
                    summary= _ "New Objectives:"
                    side=1
                    [objective]
                        description= _ "Move Clammie to the exit"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "Death of Clammie"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Death of Kennison"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Turns run out"
                        condition=lose
                    [/objective]
                    note={NEW_GOLD_CARRYOVER_NOTE_40}
                [/objectives]

                # add 33 more turns to turn limit:
                {VARIABLE turns 33}
                {VARIABLE_OP turns add $turn_number}

                [modify_turns]
                    value=$turns
                [/modify_turns]

                {VARIABLE chapter 4}
            [/then]
        [/if]
    [/event]

    # keeps the green tint while in sewer:
    [event]
        name=new turn
        first_time_only=no
        [if]
            [variable]
                name=chapter
                equals=4
            [/variable]
            [then]
                {COLOR_ADJUST 0 25 0}
            [/then]
        [/if]
    [/event]

    # keeps the shroud over ground level:
    [event]
        name=side 4 turn
        first_time_only=no
        [if]
            [variable]
                name=chapter
                equals=4
            [/variable]
            [then]
                [place_shroud]
                    x=1-45
                    y=1-21
                [/place_shroud]
            [/then]
        [/if]
    [/event]

    # Greta is found in village
    [event]
        name=moveto
        [filter]
            side=1
            x,y=38,24
        [/filter]

        # get variable on Clammie's location. Use to position Greta
        [store_unit]
            variable=clammie_store
            [filter]
                id=Clammie
            [/filter]
        [/store_unit]
        {VARIABLE temp_x $clammie_store.x}
        {VARIABLE temp_y $clammie_store.y}

        [move_unit_fake]
            type=Giant Rat
            side=3
            x=38,$temp_x
            y=24,$temp_y
        [/move_unit_fake]

        [unit]
            id=Greta
            name= _ "Greta"
            unrenamable=yes
            type=Bosavi
            x=$temp_x
            y=$temp_y
            side=5
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_LOYAL}
        [/unit]

        # animate Clammie to face Greta
        [animate_unit]
            flag=victory
            [filter]
                id=Clammie
            [/filter]
            [facing]
                [filter]
                    id=Greta
                [/filter]
            [/facing]
        [/animate_unit]

        # animate Greta to face Clammie
        [animate_unit]
            flag=victory
            [filter]
                id=Greta
            [/filter]
            [facing]
                [filter]
                    id=Clammie
                [/filter]
            [/facing]
        [/animate_unit]

        [message]
            speaker=Clammie
            message= _ "That unfortunate creature! It looks like she hasn't eaten in days!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "What creature? All I see is a nasty old rat."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Perhaps she'd like a nibble of duckweed pods."
        [/message]

        # Greta befriends Clammie
        [sound]
            name=bite-small.ogg
            repeat=2
        [/sound]

        {MODIFY_UNIT id=Greta side 1}

        [message]
            speaker=Clammie
            message= _ "I will name you Greta!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "It appears another ally has cast its lot with you. At this rate, we'll be an army before you arrive home."
        [/message]
        [message]
            speaker=Clammie
            message= _ "It's no harder than training a bat."
        [/message]
        [message]
            speaker=Kennison
            message= _ "I suppose that is so. -- What's that sound?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Eh?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Probably nothing ... but it occurs to me that Greta may not be the only one of her kind down here."
        [/message]

        # place rat king:
        {UNIT 5 Bosavi 45 31 (
            hitpoints=36
            max_hitpoints=36
            [abilities]
                {ABILITY_LEADERSHIP_LEVEL_1}
                {ABILITY_SKIRMISHER}
            [/abilities]
            canrecruit=yes
            recruit=Giant Rat, Bosavi
        )}

        [allow_recruit]
            side=5
            type=Giant Rat, Bosavi
        [/allow_recruit]

#ifdef EASY
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Bosavi 1}
#endif
#ifdef NORMAL
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Bosavi 2}
#endif
#ifdef HARD
        {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Bosavi 3}
#endif

        # determine number of rats by difficulty
        [set_variable]
            name=ratfoes
            {QUANTITY value 7 10 14}
        [/set_variable]

        # add some rats
        {SCATTER_UNITS $ratfoes "Giant Rat" 3 (
            x=22-44
            y=24-32

            # prevents rats stuck inside walls:
            [not]
                terrain=Xos,Xu,Wuo
            [/not]

            # prevents rats next to nearby units:
            [not]
                [filter]
                [/filter]
            [/not]

            # prevents rats in hexes adjacent to nearby units:
            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=5
            random_traits=yes
        )}

        # Team 5 appears in status table
        [modify_side]
            side=5
            hidden=false
        [/modify_side]

        {VARIABLE found_greta yes}
    [/event]

    # rat battle won't trigger if you don't find Greta ... therefore:
    [event]
        name=moveto
        [filter]
            side=1
            x=22
            y=26-31
        [/filter]

        {IF_VAR found_greta not_equals yes (
            [then]
                [message]
                    speaker=Kennison
                    message= _ "What's that sound?"
                [/message]
                [message]
                    speaker=Clammie
                    message= _ "Eh?"
                [/message]
                [message]
                    speaker=Kennison
                    message= _ "Probably nothing ..."
                [/message]

                # place rat king:
                {UNIT 5 Bosavi 45 31 (
                    hitpoints=36
                    max_hitpoints=36
                    [abilities]
                        {ABILITY_LEADERSHIP_LEVEL_1}
                        {ABILITY_SKIRMISHER}
                    [/abilities]
                    canrecruit=yes
                    recruit=Giant Rat, Bosavi
                )}

                [allow_recruit]
                    side=5
                    type=Giant Rat, Bosavi
                [/allow_recruit]

#ifdef EASY
                {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Bosavi 1}
#endif
#ifdef NORMAL
                {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Bosavi 2}
#endif
#ifdef HARD
                {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Bosavi 3}
#endif

                # determine number of rats by difficulty
                [set_variable]
                    name=ratfoes
                    {QUANTITY value 7 10 14}
                [/set_variable]

                {SCATTER_UNITS $ratfoes "Giant Rat" 3 (
                    x=22-44
                    y=24-32

                    # prevents rats stuck inside walls:
                    [not]
                        terrain=Xos,Xu,Wuo
                    [/not]

                    # prevents rats next to nearby units:
                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    # prevents rats in hexes adjacent to nearby units:
                    [not]
                        [filter_adjacent_location]
                            [filter]
                            [/filter]
                        [/filter_adjacent_location]
                    [/not]
                ) (
                    side=5
                    random_traits=yes
                )}
            [/then]
        )}
    [/event]

    # getting out of sewer
    [event]
        name=moveto
        [filter]
            id=Clammie
            x=45
            y=25
        [/filter]
        [message]
            speaker=Kennison
            message= _ "My dear swamp goblin, the days when I was welcome in Fursnatch appear to have ended. You have saved my life and I am in your debt. Is it possible we may cast our lot together? My skills may be useful to you and your tribe."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Nothing could please me more, Kennison. Perhaps you can teach some of my people to use a bow. I must warn you that goblins are not quick learners, however."
        [/message]
        [message]
            speaker=Kennison
            message= _ "That is fine. I am a very slow teacher so we should get on swimmingly."
        [/message]

        [sound]
            name=ambient/morning.ogg
        [/sound]

        {COLOR_ADJUST 0 0 0}

        [modify_side]
            side=1
            shroud=no
        [/modify_side]

        # Archduke gets a message
        [kill]
            id=Archduke
        [/kill]
        [unit]
            type=Master at Arms
            id=Archduke
            name= _ "Archduke"
            unrenamable=yes
            x,y=42,1
            side=4
            {IS_HERO}
        [/unit]

        [scroll_to_unit]
            id=Archduke
        [/scroll_to_unit]

        [unit]
            type=Footpad
            gender=female
            side=4
            x,y=45,1
            id=Dulonna
            name= _ "Dulonna"
        [/unit]

        {MOVE_UNIT (id=Dulonna) 43 2}

        [message]
            speaker=Archduke
            message= _ "A botch, you say?"
        [/message]
        [message]
            speaker=Dulonna
            message= _ "Your uncle escaped, and no one else could successfully impersonate your corpse, sir."
        [/message]
        [message]
            speaker=Archduke
            message= _ "No matter. Spread word that my uncle attempted to take my life. Put a price on his head – a thousand gold will do. I want no suspicion to fall upon Shining! He cannot know we are on to him!"
        [/message]

        # Shining gets a message

        {VARIABLE shining_store.hitpoints $shining_store.max_hitpoints}
        {VARIABLE shining_store.facing se}

        [unstore_unit]
            variable=shining_store
            x,y=22,2
        [/unstore_unit]

        # in case this is the first scenario:
        [if]
            [have_unit]
                id=Shining
            [/have_unit]
            [else]
                [unit]
                    type=Knight
                    id=Shining
                    name= _ "Knight Shining"
                    unrenamable=yes
                    side=2
                    x,y=22,2
                    facing=se
                    {IS_HERO}
                    [modifications]
                        {TRAIT_INTELLIGENT}
                        {TRAIT_QUICK}
                    [/modifications]
                [/unit]
            [/else]
        [/if]

        [scroll_to_unit]
            id=Shining
        [/scroll_to_unit]

        [unit]
            type=Ruffian
            side=2
            x,y=25,1
            id=Blinvan
            name= _ "Blinvan"
        [/unit]

        {MOVE_UNIT id=Blinvan 23 2}

        [message]
            speaker=Shining
            message= _ "A botch, you say?"
        [/message]
        [message]
            speaker=Blinvan
            message= _ "Rashki and the Archduke are nowhere to be found. But the Archduke has placed a bounty on his uncle's head."
        [/message]
        [message]
            speaker=Shining
            message= _ "The fool thinks his uncle is behind this. Good! Rashki has been paid well. He shall finish this job properly. But what if this uncle is found alive? He may well tell more than ought be known! I'll collect this bounty myself -- and ensure the Archduke remains in the dark."
        [/message]
        [message]
            speaker=Blinvan
            message= _ "But where would the rascal hide? No town would give him shelter."
        [/message]
        [message]
            speaker=Shining
            message= _ "Indeed, the only place he can hide is Pogo Bog! I heard a healer took up residence there. I'll start my search at the healer's shack."
        [/message]

        {CLEAR_VARIABLE chapter,clammie_store,clammie_experience,hesaidthis,ratfoes,ah_yes,temp_x,temp_y,new_traits,guards_are_gone,starting_spearmen,found_greta,turns,sp_1_open,sp_2_open,sp_3_open,ksaidthis1,ksaidthis,torchblocker}

        # store Sydd if he's alive
        [if]
            [have_unit]
                side=4
                id=Sydd
            [/have_unit]
            [then]
                [store_unit]
                    variable=sydd_store
                    [filter]
                        id=Sydd
                    [/filter]
                [/store_unit]
            [/then]
        [/if]

        # store Phillips if he's alive
        [if]
            [have_unit]
                side=4
                id=Phillips
            [/have_unit]
            [then]
                [store_unit]
                    variable=phillips_store
                    [filter]
                        id=Phillips
                    [/filter]
                [/store_unit]
            [/then]
        [/if]

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]

    # out of time
    [event]
        name=time over
        [message]
            speaker=Clammie
            message= _ "Out of time!"
        [/message]
        [message]
            speaker=Clammie_assassin
            message= _ "Out of time!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Clammie's death
    [event]
        name=last breath
        [filter]
            id=Clammie
            [or]
                id=Clammie_assassin
            [/or]
        [/filter]
        [message]
            speaker=unit
            message= _ "Perhaps I need a better strategy ..."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Kennison's death
    [event]
        name=last breath
        [filter]
            id=Kennison
        [/filter]
        [message]
            speaker=Kennison
            message= _ "Clever stroke, that! Well executed, quite bold ... but most unsporting of you, old bean!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Phillips' death
    [event]
        name=last breath
        [filter]
            id=Phillips
        [/filter]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "Phillips is defeated for now, but his heavy armor prevents a killing blow -- he escapes before you get another chance!"
        [/message]

        [store_unit]
            variable=phillips_store
            kill=yes
            [filter]
                id=Phillips
            [/filter]
        [/store_unit]
    [/event]

    [event]
        name=attacker hits
        first_time_only=yes
        [filter_second]
            id=Clammie
        [/filter_second]
        # to avoid talking to rats:
        [filter]
            race=human
        [/filter]
        [message]
            speaker=Clammie
            message= _ "Under different conditions, I'd stand my ground and fight. ... However, the odds seem tipped against me."
        [/message]
    [/event]

    [event]
        name=attacker hits
        first_time_only=yes
        [filter]
            id=Kennison
        [/filter]
        # to avoid talking rats:
        [filter_second]
            race=human
        [/filter_second]
        [message]
            speaker=second_unit
            message= _ "Arrrrh! You pedigreed bastard!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "That's an oxymoron, moron!"
        [/message]
    [/event]

    # Sydd's death
    [event]
        name=last breath
        [filter]
            id=Sydd
        [/filter]
        [message]
            speaker=Sydd
            message= _ "<i>mutters</i>"
        [/message]

        [message]
            speaker=second_unit
            message= _ "What did he say?"
        [/message]

        {CLEAR_VARIABLE sydd_store}
    [/event]

    {HERO_DEATHS}
[/scenario]

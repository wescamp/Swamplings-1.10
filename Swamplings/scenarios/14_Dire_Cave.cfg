#textdomain wesnoth-swamplings

[scenario]
    id=14_Dire_Cave
    name= _ "Dire Cave"
    map_data="{~add-ons/Swamplings/maps/Cotdw01.map}"
    {SCENARIO_MUSIC "calm-before-storm.ogg"}
    turns=-1
    victory_when_enemies_defeated=no

    {UNDERGROUND}

    next_scenario=15_Hammerheads

    [side]
        type=Goblin Rouser Sw
        id=Clammie
        name= _ "Clammie"
        unrenamable=yes
        side=1
        canrecruit=yes
        recruit=Vampire Bat,Goblin Spearman Sw,Wolf Rider Sw,Goblin Pillager,Goblin Mimic,Goblin Slave
        team_name=1
        user_team_name=_"Clammie and Co."
        controller=human
        shroud=yes
        {GOLD 450 450 400}
        [modifications]
            {TRAIT_SWAMPSAVVY}
        [/modifications]
    [/side]
    [side]
        no_leader=yes
        hidden=yes
        side=2
        team_name=2
        user_team_name=_"Saurian Flashback"
        income=-2
        [ai]
            aggression=.8
        [/ai]
        [ai]
            village_value=0
            [goal]
                [criteria]
                    terrain=*^V*
                [/criteria]
                value=0
            [/goal]
        [/ai]
        # later, side 2 becomes the bones, hence the flag variant:
        {FLAG_VARIANT undead}
        {GOLD 0 0 0}
    [/side]
    [side]
        side=3
        team_name=3
        user_team_name=_"Zombie Batcrafter"
        hidden=yes
        type=Soulless
        id=Batcrafter
        canrecruit=yes
        recruit=Soulless,Walking Corpse
        x,y=39,43
        ai_special=guardian
        # the spear guardian is on this side, and often he won't attack the holder of the multi spear. Even with aggression=1 he often just stands there, so the caution is gone too:
        [ai]
            caution=0.0
            aggression=1
        [/ai]
        {FLAG_VARIANT undead}
        {GOLD 250 250 300}
    [/side]
    # this side will recruit up to 4 Soulless at Hard difficulty, otherwise 2:
#ifndef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Soulless 2}
#else
    {LIMIT_CONTEMPORANEOUS_RECRUITS 3 Soulless 4}
#endif
    {RECRUIT_UNIT_VARIATIONS 3 Soulless none,bat}
    {RECRUIT_UNIT_VARIATIONS 3 (Walking Corpse) none,bat,bat}

    [side]
        side=4
        team_name=1
        user_team_name=_"Xaztex's Souls"
        hidden=yes
        type=Spectre
        profile=portraits/undead/transparent/ghost.png
        id=Xaztex
        name= _ "Xaztex"
        unrenamable=yes
        canrecruit=yes
        recruit=Ghost,Wraith
        x,y=26,15
        # this doesn't really work:
        share_maps=yes
        # this is only for fog, but worth a shot:
        share_view=yes
        [ai]
            # an attempt to encourage these guys to not waste a lot of time going after villages and actually help out. Never actually worked, though:
            #			village_value=0
            #			[goal]
            #				[criteria]
            #					terrain=*^V*
            #				[/criteria]
            #				value=0
            #			[/goal]

            # protect main characters:
            [goal]
                name=protect_unit
                [criteria]
                    [filter]
                        id=Kennison
                        [or]
                            id=Eeep
                        [/or]
                        [or]
                            id=Skandix
                        [/or]
                    [/filter]
                [/criteria]
                value=2
                protect_radius=2
            [/goal]
            # protect Clammie:
            [goal]
                name=protect_unit
                [criteria]
                    [filter]
                        id=Clammie
                    [/filter]
                [/criteria]
                value=3
                protect_radius=2
            [/goal]
        [/ai]
        {FLAG_VARIANT undead}
        {GOLD 250 250 200}
    [/side]
#ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Wraith 2}
#endif
#ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 Wraith 1}
#endif

    [side]
        side=5
        team_name=5
        user_team_name=_"Kleezyx's Hordes"
        hidden=yes
        type=Ghast Sw
        id=Kleezyx_Ghast
        name= _ "Kleezyx"
        unrenamable=yes
        canrecruit=yes
        recruit=Skeleton,Ghost,Skeleton Archer,Walking Corpse,Soulless
        x,y=3,3
        {FLAG_VARIANT undead}
        {GOLD 1100 1200 1400}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Ghost 1}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Skeleton 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Skeleton Archer" 2}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 Soulless 4}
    {RECRUIT_UNIT_VARIATIONS 5 "Soulless" none,bat,goblin,saurian,mounted,troll,dwarf}
    {RECRUIT_UNIT_VARIATIONS 5 (Walking Corpse) none,none,goblin,goblin,goblin,goblin,bat,saurian,mounted,troll,dwarf,swimmer,archer}

    [item]
        x,y=22,27
        image=items/spear-fancy.png
    [/item]
    [item]
        x,y=52,31
        image=items/altar-flipped.png
    [/item]
    [item]
        x,y=15,12
        image=items/soothsayer-statue-w.png
    [/item]
    [item]
        x,y=27,37
        image=items/soothsayer-statue-w.png
    [/item]
    [item]
        x,y=29,22
        image=items/soothsayer-statue-e.png
    [/item]
    [item]
        x,y=31,37
        image=items/soothsayer-statue-e.png
    [/item]
    [item]
        x,y=27,21
        image=items/ambusher-statue-w.png
    [/item]
    [item]
        x,y=31,21
        image=items/ambusher-statue-e.png
    [/item]
    [item]
        x,y=27,19
        image=items/enchantress-statue-e.png
    [/item]
    [item]
        x,y=55,4
        image=items/enchantress-statue-e.png~FL(horiz)
    [/item]
    [item]
        x,y=31,19
        image=items/revenant-statue-w.png
    [/item]
    [item]
        x,y=47,21
        image=items/revenant-statue-w.png~FL(horiz)
    [/item]
    [item]
        x,y=1,3
        image=items/dragonstatue.png
    [/item]
    [item]
        x,y=23,9
        image=items/dragonstatue.png~FL(horiz)~CS(100,100,100)
    [/item]
    [item]
        x,y=25,33
        image=items/halberdier-statue-w.png
    [/item]
    [item]
        x,y=30,18
        image=items/halberdier-statue-w.png~FL(horiz)
    [/item]
    [item]
        x,y=49,30
        image=items/myrmidon-statue-w.png
    [/item]
    [item]
        x,y=28,18
        image=items/myrmidon-statue-w.png~FL(horiz)
    [/item]
    [item]
        x,y=19,8
        image=items/flanker-statue-e.png~FL(horiz)~CS(100,100,100)
    [/item]
    [item]
        x,y=25,35
        image=items/flanker-statue-e.png~FL(horiz)
    [/item]

    {ANIMATED_MAUSOLEUM 13 18}

    {OBJ_POTION_HOLY 30 18 holy_water1}
    {OBJ_POTION_HOLY 34 13 holy_water2}
    {OBJ_POTION_HOLY 54 25 holy_water3}

    [event]
        name=prestart

        {EEEP_MENU}
        {MISRIS_MENU}
        {SS_TRAIT_ON_ADVANCEMENT}
        {MISRIS_RECRUITING_FIX}

        # in Easy and Normal games, the entrance to the Bones is closed until after the Direwolf altar event:
#ifndef HARD
        [terrain]
            x=44
            y=22
            terrain=Xu
            # later, this changes to Wwg
        [/terrain]
#endif

        [sound_source]
            id=mausoleum
            sounds=ambient/campfire.ogg
            x,y=13,18
            fade_range=2
            full_range=2
            loop=-1
        [/sound_source]

        # Clammie is here to eliminate scrolling:
        [hide_unit]
            x,y=50,40
        [/hide_unit]
    [/event]

    [event]
        name=start

		# in Easy games, Clammie can recruit level 1's:
		#ifdef EASY
		{SS_TRAIT_ON_RECRUITMENT ("Goblin Impaler Sw","Goblin Rouser 2Sw","Goblin Moonbeam")}

        [allow_recruit]
            [filter_side]
            	side=1
            [/filter_side]
            type=Goblin Impaler Sw,Goblin Rouser 2Sw,Goblin Moonbeam
        [/allow_recruit]
		#endif

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=48,38
            radius=4
        [/remove_shroud]

        {NAMED_GENERIC_UNIT 2 (Saurian Child) 48 38 Child_Skandix (_"Skandix")}
        {MOVE_UNIT (id=Child_Skandix) 49 40}
        {NAMED_GENERIC_UNIT 2 (Saurian Child) 45 34 Child_Xaztex (_"Xaztex")}
        {MOVE_UNIT (id=Child_Xaztex) 48 36}

        [message]
            speaker=Child_Xaztex
            message= _ "Wait! Wait up! Hey Skandix! Wait!"
        [/message]

        {MOVE_UNIT (id=Child_Xaztex) 48 38}

        [scroll_to]
            x,y=49,40
        [/scroll_to]

        [message]
            speaker=Child_Xaztex
            message= _ "... I've never been this far before, have you?"
        [/message]

        {MODIFY_UNIT (id=Child_Skandix) facing nw}

        [message]
            speaker=Child_Skandix
            message= _ "Yes."
        [/message]
        [message]
            speaker=Child_Xaztex
            message= _ "You have? When?"
        [/message]
        [message]
            speaker=Child_Skandix
            message= _ "Just a little further ... I want to show you something."
        [/message]

        {NAMED_UNIT 2 (Saurian Oracle) 46 42 Kleezyx (_"Kleezyx") (
            profile="portraits/saurian-augur_jormungandr.png"
        )}
        {MOVE_UNIT (id=Kleezyx) 47 39}

        {MODIFY_UNIT (id=Child_Xaztex) facing sw}

        [message]
            speaker=Kleezyx
            message= _ "That's fine, Skandix, good work."
        [/message]
        [message]
            speaker=Child_Skandix
            message= _ "Yes, my Oracle."
        [/message]
        [message]
            speaker=Child_Xaztex
            message= _ "Who the?"
        [/message]
        [message]
            speaker=Kleezyx
            message= _ "You must be Xaztex. Skandix tells me you two are very good friends."
        [/message]
        [message]
            speaker=Child_Xaztex
            message= _ "Huh, yup. We did the blood oath. I would die for Skandix."
        [/message]
        [message]
            speaker=Kleezyx
            message= _ "You hatchlings barely know what life is, yet you'd throw it away on a friendship? Foolish. On the other hand ... a great prophecy shapes us all, from the greatest to the lowliest. Take him."
        [/message]

        # Goblin slaves take Xaztex.
        {NAMED_GENERIC_UNIT 2 (Goblin Mimic) 48 36 Bright_Eyes (_"Bright Eyes")}
        {NAMED_GENERIC_UNIT 2 (Goblin Mimic) 47 37 Fingers (_"Fingers")}
        {MOVE_UNIT (id=Bright_Eyes) 48 37}
        {MODIFY_UNIT (id=Bright_Eyes) facing sw}
        {MOVE_UNIT (id=Fingers) 47 38}

        [message]
            speaker=Child_Xaztex
            message= _ "Skandix? Help!"
        [/message]

        {MOVE_UNIT (id=Child_Skandix) 46 42}

        {MOVE_UNIT (id=Kleezyx) 47 42}
        {MODIFY_UNIT (id=Kleezyx) facing sw}

        [place_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=50,36
            radius=10
        [/place_shroud]

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=47,42
            radius=4
        [/remove_shroud]

        {MOVE_UNIT (id=Child_Xaztex) 50 36}
        {MOVE_UNIT (id=Bright_Eyes) 51 36}
        {MOVE_UNIT id=Fingers 50 35}

        [scroll_to]
            x,y=46,43
        [/scroll_to]

        {MODIFY_UNIT (id=Kleezyx) facing sw}

        [message]
            speaker=Kleezyx
            message= _ "This is difficult, is it not, lad? Yet the prophecy cannot be denied! If you don't make the sacrifice, then your reward will pass to someone else. Perhaps you are not meant to be an augur. Perhaps you are too weak."
        [/message]

        {MODIFY_UNIT (id=Child_Skandix) facing ne}

        [message]
            speaker=Child_Skandix
            message= _ "<i>Weak?</i> Skandix is not weak! Skandix will be the greatest augur in all the twelve ages!"
            sound=hiss.wav
        [/message]

        [sound]
            name=ambient/wardrums.ogg
        [/sound]

        [message]
            speaker=Kleezyx
            message= _ "The knife, Skandix. Take the knife."
        [/message]
        [message]
            speaker=Child_Skandix
            message= _ "Yes, my Oracle."
        [/message]

        {UNIT 2 (Saurian Augur) 48 40 (
            id=Zandler
            name=_"Zandler"
            profile=unit_image
        )}
        {MOVE_UNIT (id=Zandler) 48 41}
        {MODIFY_UNIT (id=Zandler) facing sw}

        [message]
            speaker=Zandler
            message= _ "Oracle Kleezyx? The hatchling is secured on the altar."
        [/message]

        {MODIFY_UNIT (id=Kleezyx) facing ne}

        [message]
            speaker=Kleezyx
            message= _ "You mean the offering. We refer to him as the <i>offering,</i> Zandler."
        [/message]
        [message]
            speaker=Child_Skandix
            message= _ "My Oracle? If I do this ... this sacrifice ... the great reward happens?"
        [/message]

        {MODIFY_UNIT id=Kleezyx facing sw}

        [message]
            speaker=Kleezyx
            message= _ "Ha ha! Do not doubt, Skandix! Never doubt!"
        [/message]
        [message]
            speaker=Kleezyx
            message= _ "... it could mean your doom!"
        [/message]

        {FADE_TO_BLACK}

        [sound]
            name=hiss.wav
        [/sound]

        [kill]
            side=2
            animate=no
        [/kill]

        [scroll_to]
            x,y=30,43
        [/scroll_to]

        {FADE_IN}

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=30,44
            radius=6
        [/remove_shroud]

        #	{COLOR_ADJUST 0 0 0}

        {INCIDENTAL_MUSIC gameplay06.ogg}
        {APPEND_MUSIC the_dangerous_symphony.ogg}
        {APPEND_MUSIC gameplay06.ogg}

        {TELEPORT_UNIT id=Clammie 30 44}

        [place_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=47,40
            radius=6
        [/place_shroud]

        [unhide_unit]
        [/unhide_unit]

        {MOVE_UNIT id=Clammie 30 43}

        [recall]
            id=Greta
            x,y=35,43
            show=yes
        [/recall]
        [if]
            [have_unit]
                id=Greta
            [/have_unit]
            [then]
                [capture_village]
                    side=1
                    x,y=35,43
                [/capture_village]
            [/then]
        [/if]

        {IF_VAR Reed_is_dead not_equals yes (
            [then]
                [recall]
                    id=Reed
                    x,y=29,43
                [/recall]

                # in case this is the first scenario:
                [if]
                    [have_unit]
                        id=Reed
                    [/have_unit]
                    [else]
                        [unit]
                            type=Goblin Mimic
                            id=Reed
                            name= _ "Reed"
                            unrenamable=yes
                            x,y=29,43
                            side=1
                            [modifications]
                                {TRAIT_LOYAL}
                            [/modifications]
                            {IS_LOYAL}
                            animate=yes
                            facing=se
                        [/unit]
                    [/else]
                [/if]
            [/then]
            [else]
                # if Reed is dead, create a new Goblin Mimic:
                {UNIT 1 (Goblin Mimic) 29 43 (animate=yes)}
            [/else]
        )}

        [role]
            role=Mimic_Slave
            type=Goblin Mimic
            side=1
        [/role]

        # get the Mimic's name:
        {STORE_UNIT_VAR (type,side=Goblin Mimic,1) name Mimic_name}

        [message]
            speaker=Clammie
            message= _ "How long have you been a slave, $Mimic_name?"
        [/message]
        [message]
            role=Mimic_Slave
            message= _ "All my life, sir. Never knew a goblin could be anything else."
        [/message]

        # enter Skandix
        [recall]
            id=Skandix
            x,y=31,44
            show=no
        [/recall]
        [if]
            [have_unit]
                id=Skandix
            [/have_unit]
            [else]
                [unit]
                    id=Skandix
                    name= _ "Skandix"
                    unrenamable=yes
                    type=Saurian Augur
                    side=1
                    x,y=31,44
                    {IS_HERO}
                    animate=no
                [/unit]
            [/else]
        [/if]

        {MOVE_UNIT id=Skandix 31 43}
        {MODIFY_UNIT (id=Skandix) facing sw}

        [message]
            speaker=Skandix
            message= _ "We never mistreat our slaves! Only if they deserve it!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Many goblins do serve as slaves. We fight in orcish armies, but the orcs hardly consider us equals. My tribe descended from a small group that ... um ... separated from the orcs several generations ago. We live in total freedom, surviving by our wits."
        [/message]
        [message]
            role=Mimic_Slave
            message= _ "That must be very difficult for you."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Freedom has some benefits, by the way."
        [/message]
        [message]
            role=Mimic_Slave
            message= _ "I wouldn't know. My master died when the city fell. I don't know what I'll do now. I'm lost in the world."
        [/message]

        # enter Kennison:
        [recall]
            id=Kennison
            x,y=28,44
            show=no
        [/recall]
        [if]
            [have_unit]
                id=Kennison
            [/have_unit]
            [else]
                [unit]
                    id=Kennison
                    name= _ "Kennison"
                    unrenamable=yes
                    type=Bowman
                    {IS_HERO}
                    profile=portraits/humans/transparent/duelist.png
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications]
                    side=1
                    x,y=28,44
                    animate=no
                [/unit]
                [object]
                    [filter]
                        id=Kennison
                    [/filter]
                    silent=yes
                    duration=forever
                    [effect]
                        apply_to=attack
                        range=ranged
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_POISON}
                        [/set_specials]
                    [/effect]
                [/object]
            [/else]
        [/if]

        {MOVE_UNIT id=Kennison 28 42}
        {MODIFY_UNIT (id=Kennison) facing se}
        {MODIFY_UNIT (type=Goblin Mimic) facing nw}

        [message]
            speaker=Kennison
            message= _ "Why not cast your lot with us? I'm a bit lost in the world myself. I'm not safe around the Archduke any longer. He has about as much regard for me as Skandix here."
        [/message]
        [message]
            speaker=Skandix
            message= _ "I CURSE YOU, HUMAN!"
            sound=hiss.wav
        [/message]

        # enter Eeep:
        [recall]
            id=Eeep
            x,y=31,44
            show=no
        [/recall]
        [if]
            [have_unit]
                id=Eeep
            [/have_unit]
            [else]
                [unit]
                    id=Eeep
                    name= _ "Eeep"
                    unrenamable=yes
                    side=1
                    type=Wolf Rider Sw
                    profile="portraits/transparent/eeepwr.png"
                    [modifications]
                        {TRAIT_SWAMPSAVVY}
                        {TRAIT_DIM}
                        {TRAIT_LOYAL}
                    [/modifications]
                    {IS_HERO}
                    x,y=31,44
                    animate=no
                [/unit]
            [/else]
        [/if]

		# if Eeep's still not a wolfrider, use night portrait:
        {IF_VAR Eeep_is_wr equals yes (
			[else]
		        {MODIFY_UNIT id=Eeep profile "portraits/transparent/eeep-and-wolf-night.png"}
			[/else]
		)}

        {MOVE_UNIT id=Eeep 28 41}
        {MOVE_UNIT id=Clammie 29 42}
        {MODIFY_UNIT (id=Eeep) facing se}
        {MODIFY_UNIT (id=Clammie) facing nw}

        [message]
            speaker=Clammie
            message= _ "Eeep -- put a few units between Skandix and myself."
        [/message]
        [message]
            speaker=Eeep
            message= _ "I thought he was your friend."
        [/message]
        [message]
            speaker=Clammie
            message= _ "At best, we're partners, and this partnership may be coming to a sudden end."
        [/message]
        [message]
            speaker=Eeep
            message= _ "Just give me the word and he's skink soup. -- You no trust him? Then why do we follow him all this way?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Because this is the <i>Cave of the Dire Wolf,</i> and our tribe's entire future is tied in with wolves. If there's something here for us, we must find it. We've been lucky in our confrontations with the humans. You saw what they did in Xaffrasz ..."
        [/message]
        [message]
            speaker=Skandix
            message= _ "Enough talk, bog goblin! Let us explore the cave!"
        [/message]

#ifdef NORMAL
        {UNIT 1 (Wolf Rider Sw) 31 44 (animate=yes)}
        {UNIT 1 (Wolf Rider Sw) 29 44 (animate=yes)}
#endif
#ifdef EASY
        {UNIT 1 (Wolf Rider Sw) 31 44 (
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_LOYAL}
        )}
        {UNIT 1 (Wolf Rider Sw) 29 44 (
            animate=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_LOYAL}
        )}
#endif

        [objectives]
            side=1
            [objective]
                description= _ "Explore the Cave of the Dire Wolf"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Skandix"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Eeep"
                condition=lose
            [/objective]
            note={NEW_GOLD_CARRYOVER_NOTE_40}+{NO_EARLY_FINISH_BONUS_NOTE}
        [/objectives]
    [/event]

    # Augalol/Duldursil recall:
    [event]
        name=recall
        [filter]
            role=dwarf
        [/filter]

        [message]
            role=dwarf
            message= _ "Aaaaaaaaaaaaarrk! Now here's the map for me, a nice, deadly cave crawl. I only wonder why you didn't call me sooner. Still, I can't fault ye for havin' the brain you're born with."
        [/message]
        [message]
            speaker=Clammie
            message= _ "That's a very magnanamous statement, considering what a cantankerous old crank you are."
        [/message]
        [message]
            role=dwarf
            message= _ "Heh heh ... my gold, if you please."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=28-30
            y=20-22
        [/filter]

        {IF_VAR Xaztex_allied not_equals yes (
            [then]
                [message]
                    speaker=Skandix
                    message= _ "South east path!"
                [/message]
            [/then]
        )}
    [/event]

    # magic spear event:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x=22
            y=27
        [/filter]

        [allow_undo]
        [/allow_undo]

        [if]
            [variable]
                name=spear_picked_up
                not_equals=yes
            [/variable]

            [then]
                [message]
                    speaker=narrator
                    message=_"You've never seen a spear like this! Take it?"
                    image=items/spear-fancy.png

                    [option]
                        message= _ "Take it!"

                        [command]
                            [object]
                                id=multi_spear
                                name= _ "multi spear"
                                description=_"This magical spear inflicts your choice of arcanic, arctic or volcanic damage."
                                image=items/spear-fancy.png
                                duration=forever
                                [filter]
                                    has_weapon=spear
#                                    [and]
                                        x=22
                                        y=27
                                        side=1
#                                    [/and]
                                [/filter]
                                cannot_use_message= _ "You are no spear carrier! You are unworthy of this mighty weapon!"
                                [then]
                                    [set_variable]
                                        name=spear_picked_up
                                        value=yes
                                    [/set_variable]

                                    [remove_item]
                                        x,y=22,27
                                    [/remove_item]

                                    [sound]
                                        name=heal.wav
                                    [/sound]

                                    [fire_event]
                                        name=mof
                                    [/fire_event]
                                [/then]

                                [effect]
                                    apply_to=remove_attacks
                                    name=spear
                                    range=melee
                                [/effect]

                                [effect]
                                    apply_to=new_attack
                                    name="multi spear (arcanic)"
                                    description=_"multi spear (arcanic)"
                                    icon=attacks/staff-magic.png
                                    type=arcane
                                    range=melee
                                    damage=9
                                    number=4
                                [/effect]

                                [effect]
                                    apply_to=new_attack
                                    name="multi spear (arctic)"
                                    description=_"multi spear (arctic)"
                                    icon=attacks/iceball.png
                                    type=cold
                                    range=melee
                                    damage=8
                                    number=2
                                [/effect]
                                [effect]
                                    apply_to=new_attack
                                    name="multi spear (volcanic)"
                                    description=_"multi spear (volcanic)"
                                    icon=attacks/torch.png
                                    type=fire
                                    range=melee
                                    damage=8
                                    number=2
                                [/effect]
                            [/object]
                        [/command]
                    [/option]

                    [option]
                        message= _ "Leave it!"

                        [command]
                            [allow_undo]
                            [/allow_undo]
                        [/command]
                    [/option]
                [/message]

                [message]
                    speaker=unit
                    message= _ "<i>gasps!</i>"
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=mof
        {UNIT 3 "I8 enlightened_master_of_fire" 22 26 (
            animate=yes
            id=Guardian
            name=_"Guardian"
        )}

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=22,26
            radius=1
        [/remove_shroud]

        {MOVE_UNIT id=Guardian 23 27}
        {MODIFY_UNIT id=Guardian facing sw}

        [message]
            speaker=Guardian
            message= _ "I have been guarding that spear for millenia. Who are you to steal it?"
        [/message]

        {STORE_UNIT_VAR x,y=22,27 id id_of_spearholder}
        {STORE_UNIT_VAR x,y=22,27 name name_of_spearholder}

        [message]
            speaker=$id_of_spearholder
            message= _ "Call me $name_of_spearholder the daring!"
        [/message]
        [message]
            speaker=Guardian
            message= _ "I will call you $name_of_spearholder the pile of ash shortly. Farewell."
        [/message]

        # TODO fix so that the sounds don't work for plain spears:
        #	{MULTI_SPEAR_SOUNDS}
    [/event]

    # Um Brok is hiding in a village:
    [event]
        name=moveto
        [filter]
            x=14
            y=40
        [/filter]

        {MOVE_UNIT x,y=$x1,$y1 13 41}

        #	{IF_VAR $unit.race equals "bats" (
        #	{IF_VAR $unit.race equals bats (
        #	{IF_VAR unit.race equals bats (

        {STORE_UNIT_VAR x,y=13,41 race race_of_scout}
        {IF_VAR race_of_scout equals bats (
            [then]
                {NAMED_GENERIC_UNIT 3 (Troll Rocklobber) 14 40 Um_Brok (_"Um Brok")}

                [message]
                    speaker=Um_Brok
                    message= _ "Want to talk ... but not to bat!"
                [/message]

                {MODIFY_UNIT (id=Um_Brok) moves 0}
                {VARIABLE Um_Brok_stays yes}

                [store_unit]
                    [filter]
                        x,y=13,41
                    [/filter]
                    variable=this_bat
                [/store_unit]

                {VARIABLE this_bat.moves $this_bat.max_moves}

                [unstore_unit]
                    variable=this_bat
                [/unstore_unit]

                {CLEAR_VARIABLE this_bat}
            [/then]

            [else]
                {NAMED_GENERIC_UNIT 3 (Troll Rocklobber) 14 40 Um_Brok (_"Um Brok")}

                [fire_event]
                    name=UmBrok_attacks
                [/fire_event]
            [/else]
        )}

        {CLEAR_VARIABLE race_of_scout}
    [/event]

    # keeps Um Brok from moving until he meets nonbat foe:
    [event]
        name=turn refresh
        first_time_only=no
        [if]
            [variable]
                name=side_number
                numerical_equals=3
            [/variable]
#            [and]
                [variable]
                    name=Um_Brok_stays
                    equals=yes
                [/variable]
#            [/and]
            [then]
                {MODIFY_UNIT (id=Um_Brok) moves 0}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=13
            y=41
        [/filter]

        [if]
            [have_unit]
                side=3
                id=Um_Brok
            [/have_unit]

            [then]
                {STORE_UNIT_VAR x,y=13,41 race race_of_scout}
                {IF_VAR race_of_scout equals bats (
                    [then]
                        {IF_VAR UmBrok_attacking not_equals yes (
                            [then]
                                [message]
                                    speaker=Um_Brok
                                    message= _ "Want to talk ... but not to bat!"
                                [/message]
                            [/then]
                        )}
                    [/then]
                    [else]
                        [fire_event]
                            name=UmBrok_attacks
                        [/fire_event]
                    [/else]
                )}

                {CLEAR_VARIABLE race_of_scout}
            [/then]

            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        [/if]
    [/event]

    [event]
        name=UmBrok_attacks

        {VARIABLE UmBrok_attacking yes}

        [role]
            role=Um_Broks_foe
            x,y=13,41
        [/role]

        {MODIFY_UNIT (x,y=13,41) facing ne}

        [message]
            speaker=Um_Brok
            message= _ "Fight."
        [/message]
        [message]
            role=Um_Broks_foe
            message= _ "Eh?"
        [/message]

        {MODIFY_UNIT (id=Um_Brok) facing sw}

        [message]
            speaker=Um_Brok
            message= _ "FIIIIIIGHT!"
            sound=troll-die-3.ogg
        [/message]

        [animate_unit]
            flag=attack
            [filter]
                id=Um_Brok
            [/filter]
            [primary_attack]
                name=sling
            [/primary_attack]
            hits=yes
            [facing]
                [filter]
                    x,y=13,41
                [/filter]
            [/facing]
            [animate]
                flag=defend
                [filter]
                    x,y=13,41
                [/filter]
                [facing]
                    [filter]
                        id=Um_Brok
                    [/filter]
                [/facing]
                hits=yes
            [/animate]
        [/animate_unit]

        # unit is hurt.
        [store_unit]
            [filter]
                x,y=13,41
            [/filter]
            variable=trolls_foe
        [/store_unit]

        {VARIABLE_OP trolls_foe.hitpoints add -17}

        [unstore_unit]
            variable=trolls_foe
            find_vacant=no
            text=_"17"
            {COLOR_HARM}
        [/unstore_unit]

        [redraw]
        [/redraw]

        {IF_VAR trolls_foe[$i].hitpoints less_than_equal_to 0 (
            [then]
                [kill]
                    x,y=13,41
                    animate=yes
                    fire_event=yes
                [/kill]
            [/then]
        )}

        {CLEAR_VARIABLE trolls_foe,Um_Brok_stays}
    [/event]

    # Um Brok sees the light:
    [event]
        name=last breath
        [filter]
            id=Um_Brok
        [/filter]

        [message]
            speaker=Um_Brok
            message= _ "Huh! You strong. Maybe strong enough to fight the deads?"
        [/message]

        {MODIFY_UNIT id=Um_Brok side 1}

        [message]
            speaker=narrator
            message= _ "Um Brok, impressed by your strength, has joined your party!"
            image=wesnoth-icon.png
        [/message]

        # keep Um Brok from dying if his hitpoints are below 0:
        [store_unit]
            [filter]
                id=Um_Brok
            [/filter]
            variable=Um_Brok_store
            kill=yes
        [/store_unit]

        {IF_VAR $Um_Brok_store.hitpoints less_than_equal_to 0 (
            [then]
                {VARIABLE Um_Brok_store.hitpoints 1}
            [/then]
        )}

        [unstore_unit]
            variable=Um_Brok_store
        [/unstore_unit]

        # count 5 turns until Um Brok terraforms:
        {VARIABLE terraform $turn_number}
        {VARIABLE_OP terraform add 5}

#ifdef EASY
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "Um Brok quaffs a healing potion."
            sound=potion.ogg
        [/message]

        {FULL_HEAL id=Um_Brok}

        [sound]
            name=heal.wav
        [/sound]

        [redraw]
        [/redraw]
#endif

        {CLEAR_VARIABLE UmBrok_attacking,Um_Brok_store}
    [/event]

    [event]
        name=moveto
        [filter]
            x=10-14
            y=27-30
            id=Um_Brok
        [/filter]

        {IF_VAR UmBrok_attacking not_equals yes (
            [then]
                [fire_event]
                    name=um_brok_terraforms
                [/fire_event]
            [/then]
        )}
    [/event]

    [event]
        name=new turn
        first_time_only=no

        {IF_VAR terraform equals $turn_number (
            [then]
                [fire_event]
                    name=um_brok_terraforms
                [/fire_event]
            [/then]
        )}
    [/event]

    [event]
        name=um_brok_terraforms
        # check to be sure this won't loop:
        {IF_VAR terraform equals complete (
            [then]
                [allow_undo]
                [/allow_undo]
            [/then]
            [else]
                [message]
                    speaker=Um_Brok
                    message= _ "Nice spear over there. Long walk. Somebody want spear?"
                [/message]

                {MOVE_UNIT id=Um_Brok 20 33}
                {MODIFY_UNIT id=Um_Brok facing ne}

                [remove_shroud]
		            [filter_side]
		            	side=1
		            [/filter_side]
                    x,y=20,33
                    radius=1
                [/remove_shroud]

                [message]
                    speaker=narrator
                    message= _ "The mighty troll pushes hard against a crack in the cave wall!"
                    image=wesnoth-icon.png
                [/message]

                [sound]
                    name=troll-die-3.ogg
                [/sound]

                [sound]
                    name=rumble.ogg
                [/sound]

                [terrain]
                    x=21,22
                    y=33,32
                    terrain=Uh
                [/terrain]

                [redraw]
                [/redraw]

                [message]
                    speaker=Clammie
                    message= _ "Someone tell that troll he can take the spear for himself."
                [/message]
                [message]
                    speaker=Um_Brok
                    message= _ "NOO! UM BROK THROW ROOCK!"
                    sound=troll-die-1.ogg
                [/message]
                [message]
                    speaker=Skandix
                    message= _ "Just nod! -- Nod! -- Nodding, yes!"
                [/message]
                [message]
                    speaker=Kennison
                    message= _ "To think, I was nervous when you befriended the rat."
                [/message]

                {VARIABLE terraform complete}
            [/else]
        )}
    [/event]

    [event]
        name=moveto
        [filter]
            x=52
            y=31
        [/filter]

        [message]
            speaker=Clammie
            message= _ "Kennison, read me the words on the altar."
        [/message]

        {MOVE_UNIT id=Kennison 51 32}

        [message]
            speaker=Kennison
            message= _ "Sorry, I can't make sense of this saurian scrawl."
        [/message]

        # save Skandix's position for later (in case he is busy healing others)
        [store_locations]
            [filter]
                id=Skandix
            [/filter]
            variable=where_Skandix_was
        [/store_locations]

        {MOVE_UNIT id=Skandix 52 32}
        {MODIFY_UNIT id=Skandix facing n}

        [scroll_to]
            x,y=52,32
        [/scroll_to]

        [message]
            speaker=Skandix
            message= _ "<i>Here, the Augur Bright will place the corpse / Of his one true friend / And reap his reward.</i>"
        [/message]
        [message]
            speaker=Eeep
            message= _ "It no say what your reward be?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Quite a savage way to treat your only friend, even for a saurian."
        [/message]
        [message]
            speaker=Skandix
            message= _ "Shut up, shut up! My friend speaks."
        [/message]

        [sound]
            name=wail.wav
        [/sound]

        {TELEPORT_UNIT id=Xaztex 52 30}
        {MODIFY_UNIT id=Xaztex facing sw}

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=52,30
            radius=1
        [/remove_shroud]

        [scroll_to_unit]
            id=Xaztex
        [/scroll_to_unit]

        [message]
            speaker=Xaztex
            message= _ "Is that you, Skandix?"
        [/message]
        [message]
            speaker=Skandix
            message= _ "Yes, Xaztex. I have returned."
        [/message]
        [message]
            speaker=Xaztex
            message= _ "It must be time to fulfill the prophecy and meet your destiny."
        [/message]
        [message]
            speaker=Skandix
            message= _ "<i>And so the Augur Bright shall bear the corpse of the compassionate creature / To the cave of the dire wolf / And reap his reward.</i>"
        [/message]
        [message]
            speaker=Eeep
            message= _ "Another reward? Or were you swindled the first time?"
        [/message]
        [message]
            speaker=Skandix
            message= _ "Shut up! Kleezyx was the greatest of the oracles! He would never swindle me!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Where is Kleezyx now?"
        [/message]
        [message]
            speaker=Skandix
            message= _ "I told you, he is dead!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "Yes, but ... where is he?"
            sound=wail-long.wav
        [/message]
        [message]
            speaker=Xaztex
            message= _ "Kleezyx learned the ancient secrets of becoming a lich. But in the process, an error was made. A horrible error."
        [/message]

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=54,31
            radius=1
        [/remove_shroud]

        [sound]
            name=magic-dark-big.ogg
        [/sound]

        {MODIFY_UNIT (id=Kleezyx_Ghast) facing sw}

        [animate_unit]
            flag=pre_teleport
            [filter]
                id=Kleezyx_Ghast
            [/filter]
        [/animate_unit]

        {TELEPORT_UNIT id=Kleezyx_Ghast 54 31}

        [animate_unit]
            flag=post_teleport
            [filter]
                id=Kleezyx_Ghast
            [/filter]
        [/animate_unit]

        [scroll_to_unit]
            id=Kleezyx_Ghast
        [/scroll_to_unit]

        {MODIFY_UNIT (id=Skandix) facing ne}

        [message]
            speaker=Kennison
            message= _ "Get back!"
        [/message]
        [message]
            speaker=Xaztex
            message= _ "Kleezyx's great wisdom is lost to us now. He is merely a mindless, shambling cadaver."
        [/message]
        [message]
            speaker=Clammie
            message= _ "If he made an error in his transformation to a lich, perhaps he made an error in the prophecy as well."
        [/message]
        [message]
            speaker=Skandix
            message= _ "Blasphemy!"
        [/message]
        [message]
            speaker=Xaztex
            message= _ "Blasphemy, yes. But it may be true."
        [/message]
        [message]
            speaker=Kleezyx_Ghast
            message= _ "You! Ska ... Skandix!"
            sound=zombie-hit-1.ogg
        [/message]
        [message]
            speaker=Skandix
            message= _ "Yes, my Oracle! It is I, Skandix!"
        [/message]
        [message]
            speaker=Kleezyx_Ghast
            message= _ "It is good you have come. For I ... am hungry."
        [/message]

        # Wesnoth 1.9.1 comes to a screeching halt if you move a non-flying unit into a chasm, so:
#        {MOVE_UNIT id=Kleezyx_Ghast 53 33}
		[move_unit]
			id=Kleezyx_Ghast
			to_x=53
			to_y=33
			check_passability=no
		[/move_unit]

        # Kleezyx attacks Skandix
        [animate_unit]
            flag=attack
            [filter]
                id=Kleezyx_Ghast
            [/filter]
            [primary_attack]
                name=bite
            [/primary_attack]
            hits=yes
            [facing]
                [filter]
                    id=Skandix
                [/filter]
            [/facing]
            [animate]
                flag=defend
                [filter]
                    id=Skandix
                [/filter]
                [facing]
                    [filter]
                        id=Kleezyx_Ghast
                    [/filter]
                [/facing]
                hits=yes
            [/animate]
        [/animate_unit]

        # Skandix is poisoned
        [store_unit]
            [filter]
                id=Skandix
            [/filter]
            variable=stored_skandix
            kill=yes
        [/store_unit]

        [set_variable]
            name=stored_skandix.status.poisoned
            value="true"
        [/set_variable]

        [unstore_unit]
            variable=stored_skandix
            find_vacant=yes
        [/unstore_unit]

        {CLEAR_VARIABLE stored_skandix}

        [redraw]
        [/redraw]

        [sound]
            name=zombie-hit-1.ogg
        [/sound]

        {VARIABLE Skandix_poison yes}

        {MOVE_UNIT id=Kleezyx_Ghast 50 36}
        {MOVE_UNIT id=Kleezyx_Ghast 43 33}

        [sound]
            name=zombie-hit-1.ogg
        [/sound]

        {MOVE_UNIT id=Kleezyx_Ghast 49 30}

        [sound]
            name=magic-dark-big.ogg
        [/sound]

        # Kleezyx teleports
        [animate_unit]
            flag=post_teleport
            [filter]
                id=Kleezyx_Ghast
            [/filter]
        [/animate_unit]

        {TELEPORT_UNIT id=Kleezyx_Ghast 3 3}

        {MODIFY_UNIT id=Skandix facing sw}

        [message]
            speaker=Skandix
            message= _ "Poisoned! Is there nowhere I can heal?"
        [/message]
        [message]
            speaker=Xaztex
            message= _ "Find the altar of the Dire Wolf. There you will fully heal. But first you'll have to get past Kleezyx and his army of undead ... you'll never defeat them without arcane aid."
        [/message]
        [message]
            speaker=Clammie
            message= _ "We have no magic users except Skandix, and he can't fight on the front lines with his injuries."
        [/message]

        # see if Mimic_Slave is still alive:
        [if]
            [have_unit]
                role=Mimic_Slave
            [/have_unit]
            [else]
                [unit]
                    type=Goblin Mimic
                    role=Mimic_Slave
                    side=1
                    placement=leader
                [/unit]
            [/else]
        [/if]

        # get the Mimic's name (this may be different than it was at the start):
        {STORE_UNIT_VAR (type,side,role=Goblin Mimic,1,Mimic_Slave) name Mimic_name}

        [message]
            role=Mimic_Slave
            message= _ "Excuse me, sir, I served at an augur temple for many years and learned to mimic some of their spells."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Excellent."
        [/message]
        [message]
            role=Mimic_Slave
            message= _ "I curse you."
        [/message]

        [store_unit]
             [filter]
                 id=Skandix
             [/filter]
             variable=Skandix_store
			kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$Skandix_store.type
            side=1
            x=52,$where_Skandix_was.x
            y=32,$where_Skandix_was.y
            image_mods=~G(85)
        [/move_unit_fake]

        [unstore_unit]
            variable=Skandix_store
            x=$where_Skandix_was.x
            y=$where_Skandix_was.y
        [/unstore_unit]

		{CLEAR_VARIABLE where_Skandix_was,Skandix_store}

        [message]
            speaker=Skandix
            message= _ "Noo! More passion! More rage! I CURSE YOU!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "$Mimic_name, I have a gift for you. This robe belonged to a mage who was a great friend of my tribe."
        [/message]
        [message]
            role=Mimic_Slave
            message= _ "I wonder what this embroidered phrase means."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Where?"
        [/message]
        [message]
            role=Mimic_Slave
            message= _ "On the inside of the sleeve. As you know, white mages always have a scried message embroidered on their sleeve when they complete their training. Sometimes the meaning of that message is only learned much later in their lives. Other times, it is never understood."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Get someone to read it to you. It may be important."
        [/message]
        [message]
            role=Mimic_Slave
            message= _ "I may be a slave, sir, but I can read as well as anyone else. It says, <i>When Tyranny is destroyed, Resentment deserts.</i>"
        [/message]
        [message]
            speaker=Clammie
            message= _ "That's very interesting, but we have no time for riddles now. We must defeat Kleezyx and most of us have no arcane ability. Eeep, equip our wolf riders with as many torches as possible. It will cost a lot of gold, but fire may be our best weapon against the undead."
        [/message]
        [message]
            speaker=Xaztex
            message= _ "Clammie of the swamplings ... you may be the wisest of all goblins, but your strategy is lame."
        [/message]
        [message]
            speaker=Clammie
            message= _ "I'm open to suggestions, Xaztex. Is there a battalion of paladins I have overlooked?"
        [/message]
        [message]
            speaker=Xaztex
            message= _ "No, but you just passed through a city of dead saurians. Their spirits would fight to help Skandix meet his destiny. Behold!"
        [/message]

        # Xaztex's team now appears in status table
        [modify_side]
            [filter_side]
            	side=4
            [/filter_side]
            hidden=false
        [/modify_side]

        {MOVE_UNIT id=Xaztex 33 27}

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=33,27
            radius=2
        [/remove_shroud]

        [scroll_to]
            x,y=33,27
        [/scroll_to]

        {UNIT 4 Ghost 33 26 animate=yes}
        {UNIT 4 Ghost 34 26 animate=yes}
        {UNIT 4 Ghost 34 27 animate=yes}
        {UNIT 4 Ghost 33 28 animate=yes}

        [objectives]
            summary= _ "New Objectives:"
            side=1
            [objective]
                description= _ "Defeat Kleezyx"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Skandix"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Eeep"
                condition=lose
            [/objective]
            note={NEW_GOLD_CARRYOVER_NOTE_40}+{NO_EARLY_FINISH_BONUS_NOTE}
        [/objectives]

        {VARIABLE Xaztex_allied yes}

        [fire_event]
            name=door_open
        [/fire_event]
    [/event]

    # Batcrafter's team appears in status table after first attack:
    [event]
        name=attack
        [filter]
            side=3
        [/filter]

        [modify_side]
            [filter_side]
            	side=3
            [/filter_side]
            hidden=false
        [/modify_side]
    [/event]

    # Skandix's poison is incurable:
    [event]
        name=turn refresh
        first_time_only=no
        [if]
            [variable]
                name=Skandix_poison
                equals=yes
            [/variable]
#            [and]
                [variable]
                    name=side_number
                    numerical_equals=1
                [/variable]
#            [/and]
            [then]
                [store_unit]
                    [filter]
                        id=Skandix
                    [/filter]
                    variable=stored_skandix
                    kill=yes
                [/store_unit]

                [set_variable]
                    name=stored_skandix.status.poisoned
                    value="true"
                [/set_variable]

                [unstore_unit]
                    variable=stored_skandix
                    find_vacant=yes
                [/unstore_unit]

                [redraw]
                [/redraw]

                {CLEAR_VARIABLE stored_skandix}
                # TODO Skandix heals in villages and next to healers
            [/then]
        [/if]
    [/event]

    # if Batcrafter is defeated but Clammie hasn't visited white altar yet:
    [event]
        name=turn refresh
        first_time_only=no
        [if]
            [have_unit]
                side=3
                id=Batcrafter
            [/have_unit]
            [else]
                # check to see if they haven't already visited white altar:
                {IF_VAR Xaztex_allied not_equals yes (
                    [then]
                        # check to see if we haven't already done this:
                        {IF_VAR altar_glimmers not_equals yes (
                            [then]
                                # scroll to altar:
                                [scroll_to]
                                    x,y=52,31
                                [/scroll_to]

                                [remove_shroud]
						            [filter_side]
						            	side=1
						            [/filter_side]
                                    x,y=52,31
                                    radius=1
                                [/remove_shroud]

                                [sound]
                                    name=wail.wav
                                [/sound]

                                [item]
                                    x,y=52,31
                                    image=items/altar-flipped.png
                                    halo=halo/illuminates-aura.png:100,halo/lighthouse-aura.png:100,halo/illuminates-aura.png:100
                                [/item]

                                [remove_item]
                                    x,y=52,31
                                [/remove_item]

                                [item]
                                    x,y=52,31
                                    image=items/altar-flipped.png
                                [/item]

                                [redraw]
                                [/redraw]

                                {VARIABLE altar_glimmers yes}
                            [/then]
                        )}
                    [/then]
                )}
            [/else]
        [/if]
    [/event]

    # clear shroud so you can watch battles between sides 4 & 5:
    [event]
        name=attack
        first_time_only=no
        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=$x1,$y1
            radius=2
        [/remove_shroud]
    [/event]

    # places Lavinia on the map if you come near lake:
    [event]
        name=moveto
        [filter]
            side=1
            x=48-54
            y=1-6
        [/filter]

        {UNIT 5 Nightgaunt 42 3 (
            id=Lavinia
            name=_"Lavinia"
            max_moves=0
            moves=0
        )}

        {MODIFY_UNIT id=Lavinia type "Mermaid Siren"}
        {MODIFY_UNIT id=Lavinia profile portraits/merfolk/transparent/enchantress.png}
        {MODIFY_UNIT id=Lavinia race merman}
        {MODIFY_UNIT id=Lavinia alignment lawful}
        {MODIFY_UNIT id=Lavinia facing se}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x=41-47
            y=1-5
        [/filter]

        [remove_shroud]
            [filter_side]
            	side=1
            [/filter_side]
            x,y=42,3
            radius=1
        [/remove_shroud]

        # check to see if Lavina has already transformed:
        {STORE_UNIT_VAR id=Lavinia type Lavinia_type}
        {IF_VAR Lavinia_type equals "Mermaid Siren" (
            [then]
                # check to see if approaching unit is Clammie:
                {IF_VAR unit.id not_equals Clammie (
                    [then]
                        {IF_VAR no_repeating not_equals yes (
                            [then]
                                [message]
                                    speaker=Lavinia
                                    message= _ "Begone, fool! I will only speak to your leader."
                                [/message]

                                {VARIABLE no_repeating yes}
                            [/then]
                        )}
                    [/then]

                    # unit approaching is Clammie:
                    [else]
                        {INCIDENTAL_MUSIC siege_of_laurelmor.ogg}

                        [message]
                            speaker=Lavinia
                            message= _ "Wise leader, let me join your group! I have many treasures to offer you. Much gold and riches! I am a powerful fighter and will bring you many victories over your hated enemies! And love ... I am a great lover, let me show you!"
                        [/message]
                        [message]
                            speaker=Clammie
                            message= _ "This all sounds a bit too --"
                        [/message]
                        [message]
                            speaker=Lavinia
                            message= _ "Wait! I know what you want! What your heart truly desires! I can bring your son back to life!"
                        [/message]

                        [sound]
                            name=magic-dark-big.ogg
                        [/sound]

                        {UNIT 5 "Goblin Spearman" 43 3 (
                            id=Terro
                            name=_"Terro"
                            profile=unit_image
                            animate=yes
                        )}

                        {MODIFY_UNIT id=Terro facing se}

                        [message]
                            speaker=Terro
                            message= _ "-uuuuuuuuuuuh-"
                        [/message]
                        [message]
                            speaker=Clammie
                            message= _ "Creature, you may not join us. You are not welcome."
                        [/message]

                        # Lavinia attacks Terro
                        [animate_unit]
                            flag=attack
                            with_bars=no
                            [filter]
                                id=Lavinia
                            [/filter]
                            [primary_attack]
                                name=claws
                            [/primary_attack]
                            hits=kill
                            [facing]
                                [filter]
                                    id=Terro
                                [/filter]
                            [/facing]
                            [animate]
                                flag=defend
                                [filter_second]
                                    id=Terro
                                [/filter_second]
                                hits=yes
                                with_bars=no
                                [facing]
                                    [filter]
                                        id=Lavinia
                                    [/filter]
                                [/facing]
                            [/animate]
                        [/animate_unit]

                        [sound]
                            name=claws.ogg
                        [/sound]

                        [kill]
                            id=Terro
                            animate=yes
                        [/kill]

                        {ADVANCE_UNIT id=Lavinia Nightgaunt}
                        {MODIFY_UNIT id=Lavinia moves 8}

                        [sound]
                            name=wail-long.wav
                        [/sound]

                        {MODIFY_UNIT id=Lavinia moves 8}
                        {MODIFY_UNIT id=Lavinia profile portraits/undead/transparent/nightgaunt.png}

                        [message]
                            speaker=Lavinia
                            message= _ "Whether I am welcome or not, goblin, I shall follow thee."
                        [/message]

                        [place_shroud]
				            [filter_side]
				            	side=1
				            [/filter_side]
                            x,y=42,3
                            radius=4
                        [/place_shroud]
                    [/else]
                )}
            [/then]
        )}

        {CLEAR_VARIABLE Lavinia_type}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Lavinia
        [/filter]
        [message]
            speaker=Lavinia
            message= _ "Idiots! I would have made you immortal, like the Bones!"
        [/message]

        # TALKING BAT ALERT:

        [message]
            speaker=second_unit
            message= _ "Bones?"
        [/message]
        [message]
            speaker=Lavinia
            message= _ "Enjoy your ephemeral lifespan, insect!"
        [/message]
        [message]
            speaker=second_unit
            message= _ "Eff ... eff???"
        [/message]

        [kill]
            id=Lavinia
            animate=yes
        [/kill]
    [/event]

    # entering village near 7 bones keep will bring them to life & petrify them:
    [event]
        name=moveto
        [filter]
            side=1
            x=55
            y=12
        [/filter]

        [sound]
            name=dwarf-laugh.wav
        [/sound]

        {UNIT 2 "Death Knight" 53 15 (
            id=Tyranny
            name=_"Tyranny"
            canrecruit=yes
            animate=yes
            [abilities]
                {ABILITY_LEADERSHIP_LEVEL_3}
                {ABILITY_SUBMERGE}
            [/abilities]
        )}

        [sound]
            name=skeleton-die-1.ogg
        [/sound]

        {UNIT 2 Banebow 52 14 (
            id=Calumny
            name=_"Calumny"
            profile=portraits/undead/transparent/banebow.png
            animate=yes
        )}

        [sound]
            name=skeleton-die-2.ogg
        [/sound]

        {UNIT 2 Deathblade 54 15 (
            id=Phobia
            name=_"Phobia"
            animate=yes
        )}

        [sound]
            name=skeleton-die-1.ogg
        [/sound]

        {UNIT 2 Draug 52 15 (
            id=Vanity
            name=_"Vanity"
            profile=portraits/undead/transparent/draug.png
            animate=yes
        )}

        [sound]
            name=skeleton-die-2.ogg
        [/sound]

        {UNIT 2 "Skeleton Archer" 54 14 (
            id=Rancor
            name=_"Rancor"
            profile=portraits/undead/transparent/archer.png
            animate=yes
        )}

        [sound]
            name=skeleton-die-1.ogg
        [/sound]

        {UNIT 2 "Bone Shooter" 53 16 (
            id=Resentment
            name=_"Resentment"
            profile=portraits/undead/transparent/bone-shooter.png
            animate=yes
        )}

        [sound]
            name=skeleton-die-1.ogg
        [/sound]

        {UNIT 2 Revenant 53 14 (
            id=Want
            name=_"Want"
            profile=portraits/undead/transparent/draug-2.png
            animate=yes
        )}

        [message]
            speaker=Resentment
            message= _ "<i>We are the seven deadly bones --</i>"
            #		sound=skeleton-die-2.ogg
        [/message]
        [message]
            speaker=Phobia
            message= _ "<i>-- Seven slashes every heart owns --</i>"
        [/message]
        [message]
            speaker=Tyranny
            message= _ "<i>-- Tyranny --</i>"
        [/message]
        [message]
            speaker=Calumny
            message= _ "<i>-- Calumny --</i>"
        [/message]
        [message]
            speaker=Phobia
            message= _ "<i>-- Phobia --</i>"
        [/message]
        [message]
            speaker=Vanity
            message= _ "<i>-- Vanity --</i>"
        [/message]
        [message]
            speaker=Rancor
            message= _ "<i>-- Rancor --</i>"
        [/message]
        [message]
            speaker=Resentment
            message= _ "<i>-- Resentment --</i>"
        [/message]
        [message]
            speaker=Want
            message= _ "<i>-- and Want.</i>"
        [/message]
        [message]
            speaker=Calumny
            message= _ "<i>We are the seven deadly bones --</i>"
        [/message]
        [message]
            speaker=Tyranny
            message= _ "<i>-- Your mind we rule, your dreams we haunt.</i>"
        [/message]

        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=seven_bones
        [/store_unit]

        [kill]
            side=2
            animate=no
            fire_event=no
        [/kill]

        # petrify each of the bones:
        {FOREACH seven_bones i}
            [set_variable]
                name=seven_bones[$i].status.petrified
                value="true"
            [/set_variable]
            [unstore_unit]
                variable=seven_bones[$i]
                find_vacant=yes
            [/unstore_unit]
        {NEXT i}

        [redraw]
        [/redraw]

        [message]
            speaker=unit
            message= _ "=squeek="
        [/message]

        [sound]
            name=petrified.ogg
        [/sound]

        # update table:
        [modify_side]
            [filter_side]
            	side=2
            [/filter_side]
            hidden=no
            no_leader=no
            user_team_name=_"Seven Deadly Bones"
        [/modify_side]

        {VARIABLE bones_appear yes}

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "A wave of palpable evil sweeps through the cave!"
        [/message]

        [sound]
            name=rumble.ogg
        [/sound]

        [sound]
            name=water-blast.wav
        [/sound]

        # a flood breaks through one wall and wipes out villages:
        [terrain]
            x,y=54,11
            terrain=Wo
        [/terrain]

        [terrain]
            x,y=55,12
            terrain=Wo
        [/terrain]

        [redraw]
        [/redraw]

        [scroll_to]
            x,y=55,17
        [/scroll_to]

        [terrain]
            x,y=55,17
            terrain=Qxu
        [/terrain]

        [redraw]
        [/redraw]

        [scroll_to]
            x,y=49,23
        [/scroll_to]

        [terrain]
            x,y=49,23
            terrain=Qxu
        [/terrain]

        [redraw]
        [/redraw]

        [scroll_to]
            x,y=54,11
        [/scroll_to]
    [/event]

    # if the 7 bones are activated, coming into contact with one of them will petrify you:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            [not]
                x,y=55,17
            [/not]
            [not]
                x,y=51,17
            [/not]
            [not]
                x,y=54,17
            [/not]
            [not]
                x,y=52,17
            [/not]
            [not]
                x,y=55,13
            [/not]
            x=51-55
            y=13-17
            side=1
        [/filter]

        {IF_VAR bones_appear equals yes (
            [then]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                        #					side=1
                    [/filter]
                    variable=touched_bones
                [/store_unit]

                [set_variable]
                    name=touched_bones.status.petrified
                    value="true"
                [/set_variable]

                [kill]
                    x,y=$x1,$y1
                    animate=no
                    fire_event=no
                [/kill]

                [unstore_unit]
                    variable=touched_bones
                    find_vacant=yes
		            text= _ "!"
                [/unstore_unit]

                [sound]
                    name=petrified.ogg
                [/sound]

                [redraw]
                [/redraw]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        )}

        # if Vanity is not yet unpetrified, fire event to free it:
        {STORE_UNIT_VAR id=Vanity status.petrified Vanity_stoned}
        {IF_VAR Vanity_stoned equals yes (
            [then]
                [fire_event]
                    name=free_vanity
                [/fire_event]
            [/then]
        )}
    [/event]

    [event]
        name=free_vanity

        # un-petrify first of the bones:
        [store_unit]
            [filter]
                id=Vanity
            [/filter]
            variable=unstoned_bone
        [/store_unit]

        [kill]
            id=Vanity
            animate=no
            fire_event=no
        [/kill]

        [set_variable]
            name=unstoned_bone.status.petrified
            value="false"
        [/set_variable]

        [unstore_unit]
            variable=unstoned_bone
            find_vacant=yes
        [/unstore_unit]

        # lighted area of keep vanishes:
        [terrain]
            x,y=$unstoned_bone.x,$unstoned_bone.y
            terrain=Cud
        [/terrain]

        [redraw]
        [/redraw]

        [sound]
            name=petrified.ogg
        [/sound]

        [message]
            speaker=Vanity
            message= _ "<i>Free!</i>"
        [/message]
    [/event]

    [event]
        name=door_open

        [sound]
            name=rumble.ogg
        [/sound]

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "A deep rumbling is heard as several cave walls slide open!"
        [/message]

        #	{IF_VAR door equals 1 (
        #		[then]
        [terrain]
            x=19
            y=1-3
            terrain=Uh
        [/terrain]
        #		[/then]
        #	)}

        #	{IF_VAR door equals 2 (
        #		[then]
        [terrain]
            x=15,14
            y=13,13
            terrain=Uh
        [/terrain]
        #		[/then]
        #	)}
        [redraw]
        [/redraw]

        # Kleezyx's team now appears in status table
        [modify_side]
            [filter_side]
            	side=5
            [/filter_side]
            hidden=false
        [/modify_side]

        # in Normal games, the entrance to the Bones opens (only accessable by flying units):
#ifdef NORMAL
        [scroll_to]
            x,y=44,22
        [/scroll_to]

        [terrain]
            x=44
            y=22
            terrain=Wwg
        [/terrain]
        [redraw]
        [/redraw]
#endif
    [/event]

    # Kleezyx's last breath
    [event]
        name=last breath
        [filter]
            id=Kleezyx_Ghast
        [/filter]
        [message]
            speaker=Kleezyx_Ghast
            message= _ "I'm still hungry."
            sound=zombie-hit-1.ogg
        [/message]

        [kill]
            id=Kleezyx_Ghast
            animate=yes
        [/kill]

        [sound]
            name=rumble.ogg
        [/sound]

        [terrain]
            x=14,15
            y=22,23
            terrain=Uh
        [/terrain]

        [redraw]
        [/redraw]

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "As the undead monstrosity releases its final breath, a nearby cave wall slides open!"
        [/message]

        [message]
            speaker=Clammie
            message= _ "Quickly! We must find that second altar!"
        [/message]
        [objectives]
            summary= _ "New Objectives:"
            side=1
            [objective]
                description= _ "Find the altar of the Dire Wolf!"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Skandix"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Kennison"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Eeep"
                condition=lose
            [/objective]
            note={NEW_GOLD_CARRYOVER_NOTE_40}+{NO_EARLY_FINISH_BONUS_NOTE}
        [/objectives]
    [/event]

    # the altar of the direwolf is found:
    [event]
        name=moveto
        [filter]
            x,y=13,18
        [/filter]

        [sound]
            name=wail.wav
        [/sound]

        {UNIT 3 Ghost_Wolf 13 17 (
            id=Spirit
            name=_"Spirit"
            max_moves=0
            profile=units/monsters/direwolf.png
        )}

        {GHOST_APPEAR 13 17 units/monsters/direwolf.png 300}

        {INCIDENTAL_MUSIC calm-before-storm.ogg}

        [message]
            speaker=Spirit
            message= _ "Skandix of Xaffrasz?"
        [/message]

        [store_unit]
             [filter]
                 id=Skandix
             [/filter]
             variable=Skandix_store
			kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$Skandix_store.type
            side=1
            x=$Skandix_store.x,14
            y=$Skandix_store.y,18
            image_mods=~G(100)
        [/move_unit_fake]

        [unstore_unit]
            variable=Skandix_store
            x=14
            y=18
        [/unstore_unit]

        {CLEAR_VARIABLE Skandix_store}

        {MODIFY_UNIT id=Skandix facing nw}

        [message]
            speaker=Skandix
            message= _ "It is I."
        [/message]
        [message]
            speaker=Spirit
            message= _ "You were to bring the corpse of the compassionate creature."
        [/message]
        [message]
            speaker=Skandix
            message= _ "He is here, but still alive."
        [/message]
        [message]
            speaker=Spirit
            message= _ "Is this due to your own compassion? Or something else?"
        [/message]
        [message]
            speaker=Skandix
            message= _ "In truth, I have seen the death of too many. My childhood friend Xaztex. Oracle Kleezyk. The people of Xaffrasz. An uncurable poison flows through my own body. I am tired of death and I'm sick of this prophecy! If you don't want to reward me, I don't care. I will not kill my friend Clammie."
        [/message]
        [message]
            speaker=Spirit
            message= _ "I can restore you to full health, Skandix of Xaffrasz, but the poison in your veins is undead. It will never leave you."
        [/message]
        [message]
            speaker=Skandix
            message= _ "So I must die."
        [/message]
        [message]
            speaker=Spirit
            message= _ "Your body cannot withstand the poison. But your body can be transformed."
        [/message]

        {THUNDER (
            {ADVANCE_UNIT id=Skandix Direwolf}
            {MODIFY_UNIT id=Skandix status.poisoned "false"}
        )}

        {GHOST_FADE 13 17 units/monsters/direwolf.png 500}

        # get Skandix's location:
        [store_locations]
            [filter]
                id=Skandix
            [/filter]
            variable=where_Skandix_is
        [/store_locations]

        # Skandix gets a little fidgety over the next sequence and needs a fog clearer to keep him attentive:
        {CLEAR_FOG_NOBUG 3 $where_Skandix_is.x $where_Skandix_is.y 1}

        [message]
            speaker=Eeep
            message= _ "Eeep!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "No more 'I curse you'?"
        [/message]

        {MOVE_UNIT id=Clammie 12 18}
        {MODIFY_UNIT id=Clammie facing ne}

        [message]
            speaker=Clammie
            message= _ "If you are still there, I'd like to ask a question."
        [/message]

        {GHOST_APPEAR 13 17 units/monsters/direwolf.png 150}

        [message]
            speaker=Spirit
            message= _ "Speak, Clammie of the swamplings."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Who are you?"
        [/message]
        [message]
            speaker=Spirit
            message= _ "I was called the Swift One by my people. I am the last of the dire wolves, until today. I have awaited this day for many ages."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Won't Skandix need a female to carry on the race?"
        [/message]
        [message]
            speaker=Spirit
            message= _ "Skandix can breed with any wolf he chooses. She will bear a litter of dire wolves."
        [/message]
        [message]
            speaker=Clammie
            message= _ "What of the poison in his veins?"
        [/message]
        [message]
            speaker=Spirit
            message= _ "Skandix is now a poisonous creature. Anyone he scratches will be poisoned."
        [/message]
        [message]
            speaker=Clammie
            message= _ "What would have happened if he fulfilled the prophecy? What would have been his reward?"
        [/message]
        [message]
            speaker=Spirit
            message= _ "Your question assumes that he failed. Skandix did not fail. The prophecy was told to him in a corrupted form. In spite of that, he did what he knew was true. His reward is to live on as the greatest of the wolves. All he needs now is a compassionate rider. Do you know of any?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "It would be a great honor to ride this magnificent creature."
        [/message]

        {MODIFY_UNIT id=Skandix facing se}

        # if Clammie has the multi spear, he drops it:
        {IF_VAR id_of_spearholder equals Clammie (
            [then]
                # remove multi spear from Clammie
                [object]
                    silent=yes
                    [filter]
                        id=Clammie
                    [/filter]
                    [effect]
                        apply_to=remove_attacks
                        name=spear
                        range=melee
                    [/effect]
                [/object]

                # place spear where Clammie is (or thereabouts):
                [item]
                    x,y=12,18
                    image=items/spear-fancy.png
                [/item]
            [/then]
        )}

        # store Clammie to get his type & location:
        [store_unit]
            [filter]
                id=Clammie
            [/filter]
            variable=stored_clammie
            kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$stored_clammie.type
            side=1
            x=$stored_clammie.x,$where_Skandix_is.x
            y=$stored_clammie.y,$where_Skandix_is.y
        [/move_unit_fake]

        [kill]
            id=Skandix
            animate=no
            fire_event=no
        [/kill]

        # must unstore him before tranformation
        [unstore_unit]
            variable=stored_clammie
            x=$where_Skandix_is.x
            y=$where_Skandix_is.y
        [/unstore_unit]

        {TRANSFORM_UNIT id=Clammie (Direwolf Rider Sw)}

        # must store him again because the TRANSFORM_UNIT macro keeps his old hitpoints and changes his portrait to the generic direwolf rider:
        [store_unit]
            [filter]
                id=Clammie
            [/filter]
            variable=stored_clammie
            kill=no
        [/store_unit]

        # give Clammie's full hitpoints:
        {VARIABLE stored_clammie.hitpoints 61}
        {VARIABLE stored_clammie.ellipse "misc/ellipse-leader"}

        # fix Clammie's portrait:
        [set_variable]
            name=stored_clammie.profile
            value=portraits/transparent/rouser-2.png
        [/set_variable]

        [unstore_unit]
            variable=stored_clammie
            x=$where_Skandix_is.x
            y=$where_Skandix_is.y
        [/unstore_unit]

        # restore Leadership:
        [object]
            [filter]
                id=Clammie
            [/filter]
            silent=yes
            duration=forever
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_LEADERSHIP_LEVEL_3}
                [/abilities]
            [/effect]
        [/object]

        [sound]
            name=wolf-die.wav
        [/sound]

        [message]
            speaker=Spirit
            message= _ "Now I am free to meet my reward. Come, Xaztex."
        [/message]

        [scroll_to_unit]
            id=Xaztex
        [/scroll_to_unit]

        [kill]
            id=Xaztex
            animate=yes
        [/kill]

        [scroll_to_unit]
            id=Spirit
        [/scroll_to_unit]

        {GHOST_FADE 13 17 units/monsters/direwolf.png 150}

        [kill]
            id=Spirit
            animate=no
        [/kill]

        # in easy games, Xaztec's souls remain behind, otherwise they leave with him:
#ifndef EASY
        [kill]
            side=4
            animate=yes
        [/kill]
#endif

        {UNCLEAR_FOG_NOBUG}

        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "Your Goblin Knights can now advance to Direwolf Riders!"
        [/message]

        {MODIFY_UNIT (type=Goblin Knight 1Sw) type (Goblin Knight 2Sw)}
        {MODIFY_UNIT (type=Wolf Rider Sw) type (Wolf Rider 2Sw)}

        [if]
            [have_unit]
                type=Great Wolf
            [/have_unit]
            [then]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "Your Great Wolves can now advance to Direwolves!"
                [/message]

                {MODIFY_UNIT (type=Great Wolf) type (Great Wolf 2)}
            [/then]
        [/if]

        # prevent Clammie from recruiting any more of the old Wolf Riders:
        [disallow_recruit]
            [filter_side]
            	side=1
            [/filter_side]
            type=Wolf Rider Sw
        [/disallow_recruit]
        [allow_recruit]
            [filter_side]
            	side=1
            [/filter_side]
            type=Wolf Rider 2Sw
        [/allow_recruit]

        {INCIDENTAL_MUSIC silence.ogg}
        {APPEND_MUSIC underground.ogg}
        {APPEND_MUSIC knalgan_theme.ogg}

        {CLEAR_VARIABLE Skandix_poison,new_traits,existing_traits,clammie_store,where_Skandix_is,terraform}

        [message]
            speaker=Eeep
            message= _ "This is cave is full of amazing things -- should we keep exploring?"
            [option]
                message= _ "We're finished! Let's go!"
                [command]
                    [fire_event]
                        name=lets_go
                    [/fire_event]
                [/command]
            [/option]
            [option]
                message= _ "We must continue our exploration!"
                [command]
                    {VARIABLE Xaz_gone yes}

					[modify_side]
			            [filter_side]
			            	side=4
			            [/filter_side]
			            hidden=yes
			        [/modify_side]

                    # in Easy games, the entrance to the Bones is closed until now:
#ifdef EASY
                    [scroll_to]
                        x,y=44,22
                    [/scroll_to]

                    [message]
                        speaker=narrator
                        image="wesnoth-icon.png"
                        message= _ "With the departure of Xaztex and the Swift One, an ancient evil stirs ..."
                        sound=rumble.ogg
                    [/message]

                    [terrain]
                        x=44
                        y=22
                        terrain=Wwg
                    [/terrain]
                    [terrain]
                        x=41
                        y=20
                        terrain=Wwg
                    [/terrain]
                    [redraw]
                    [/redraw]
#endif

                    [objectives]
                        summary= _ "New Objectives:"
                        side=1
                        [objective]
                            description= _ "Explore the Cave of the Dire Wolf"
                            condition=win
                        [/objective]
                        [objective]
                            description= _ "Death of Clammie"
                            condition=lose
                        [/objective]
                        [objective]
                            description= _ "Death of Kennison"
                            condition=lose
                        [/objective]
                        [objective]
                            description= _ "Death of Eeep"
                            condition=lose
                        [/objective]
                        note= _ "When you are finished exploring, move Clammie or Eeep to the mushroom patch at the cave entrance."+{NEW_GOLD_CARRYOVER_NOTE_40}+{NO_EARLY_FINISH_BONUS_NOTE}
                    [/objectives]

                    {HIGHLIGHT_IMAGE 25 41 scenery/signpost.png ()}
                    # gives Clammie higher level of leadership if he advances:
                    {CLAMMIE_DIREWOLF_LEADER_ADVANCEMENT}
                [/command]
            [/option]
        [/message]
    [/event]

    # fire the victory event when Clammie/Eeep moves to signpost:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Clammie
            x,y=25,41
            [or]
                id=Eeep
                x,y=25,41
            [/or]
        [/filter]

        {IF_VAR stored_clammie.type equals "Direwolf Rider Sw" (
            [then]
                [fire_event]
                    name=lets_go
                [/fire_event]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        )}
    [/event]

    # Swamp Wolves should be able to get to level 3 eventually:
    [event]
        name=post advance
        first_time_only=no

        [filter]
            type=Great Wolf
        [/filter]

        {IF_VAR Xaz_gone not_equals yes (
            [else]
                {MODIFY_UNIT (type=Great Wolf) type (Great Wolf 2)}
            [/else]
        )}
    [/event]

    # Wolf Riders should be able to get to level 3 eventually:
    [event]
        name=post advance
        first_time_only=no

        [filter]
            type=Goblin Knight 1Sw
        [/filter]

        {IF_VAR Xaz_gone not_equals yes (
            [else]
                {MODIFY_UNIT (type=Goblin Knight 1Sw) type (Goblin Knight 2Sw)}
            [/else]
        )}
    [/event]

    # multi spear event
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=12,18
            [not]
                id=Clammie
            [/not]
        [/filter]

        [allow_undo]
        [/allow_undo]

        {IF_VAR id_of_spearholder equals Clammie (
            [then]
                [if]
                    [variable]
                        name=spear_picked_up2
                        not_equals=yes
                    [/variable]

                    [then]
                        [message]
                            speaker=narrator
                            message=_"You've never seen a spear like this! (okay, maybe once before ... ) Take it?"
                            image=items/spear-fancy.png

                            [option]
                                message= _ "Take it!"

                                [command]
                                    [object]
                                        name= _ "multi spear"
                                        description=_"This magical spear inflicts your choice of arcanic, arctic or volcanic damage."
                                        image=items/spear-fancy.png
                                        duration=forever
                                        [filter]
                                            has_weapon=spear
#                                            [and]
                                                x,y=12,18
                                                side=1
#                                            [/and]
                                        [/filter]
                                        cannot_use_message= _ "You are no spear carrier! You are unworthy of this mighty weapon!"
                                        [then]
                                            [set_variable]
                                                name=spear_picked_up2
                                                value=yes
                                            [/set_variable]

                                            [remove_item]
                                                x=$Clammie_x
                                                y=$Clammie_y
                                            [/remove_item]

                                            [sound]
                                                name=heal.wav
                                            [/sound]
                                        [/then]
                                        [effect]
                                            apply_to=remove_attacks
                                            name=spear
                                            range=melee
                                        [/effect]
                                        [effect]
                                            apply_to=new_attack
                                            name=spear
                                            description=_"multi spear (arcanic)"
                                            icon=attacks/staff-magic.png
                                            type=arcane
                                            range=melee
                                            damage=9
                                            number=4
                                        [/effect]
                                        [effect]
                                            apply_to=new_attack
                                            name=spear
                                            description=_"multi spear (arctic)"
                                            icon=attacks/iceball.png
                                            type=cold
                                            range=melee
                                            damage=8
                                            number=2
                                        [/effect]
                                        [effect]
                                            apply_to=new_attack
                                            name=spear
                                            description=_"multi spear (volcanic)"
                                            icon=attacks/torch.png
                                            type=fire
                                            range=melee
                                            damage=8
                                            number=2
                                        [/effect]
                                    [/object]
                                [/command]
                            [/option]

                            [option]
                                message= _ "Leave it!"

                                [command]
                                    [allow_undo]
                                    [/allow_undo]
                                [/command]
                            [/option]
                        [/message]
                    [/then]
                [/if]
            [/then]
            [else]
                [allow_undo]
                [/allow_undo]
            [/else]
        )}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x,y=1,3
        [/filter]

        [message]
            speaker=Clammie
            message= _ "These statues are troubling. Kennison, didn't you tell me of a beast called the basilisk?"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Yes, with one gaze it can-- oh dear."
        [/message]
        [message]
            speaker=Eeep
            message= _ "Any beast smarter than a fungus would have left this cave long ago."
        [/message]

		# check for Skandix
        [if]
            [have_unit]
                id=Skandix
            [/have_unit]
            [then]
                [role]
                    role=mystic
                    id=Skandix
                [/role]
            [/then]
			[else]
		        [if]
		            [have_unit]
		                id=Um_Brok
		            [/have_unit]
		            [then]
		                [role]
		                    role=mystic
			                id=Um_Brok
		                [/role]
		            [/then]
					[else]
				        [if]
				            [have_unit]
				                type=Goblin Mimic,Goblin Jinx
				            [/have_unit]
				            [then]
				                [role]
				                    role=mystic
					                type=Goblin Mimic,Goblin Jinx
				                [/role]
				            [/then]
				        [/if]
					[/else]
		        [/if]
			[/else]
        [/if]
        [message]
            role=mystic
            message= _ "Statues are not the work of a basilisk! It is written, these statues are not made of stone. They are made of holes!"
        [/message]

		{PULL_LEVER_OPTION}
    [/event]

    [event]
        name=second_chance
        first_time_only=no

		[event]
			name=moveto
	        first_time_only=no

			[filter]
				side=1
				x,y=1,3
			[/filter]

			{PULL_LEVER_OPTION}
		[/event]
    [/event]

    [event]
        name=lets_go
        [message]
            speaker=Kennison
            message= _ "Clammie, I recommend we take a different route on our way back. I expect the naga will return to Xaffrasz in greater numbers."
        [/message]
        [message]
            speaker=Clammie
            message= _ "We can circle the bog, but that will take us into Orc territory."
        [/message]
        [message]
            speaker=Kennison
            message= _ "Are the orc and goblin not brothers?"
        [/message]
        [message]
            speaker=Eeep
            message= _ "Hah! Ask Yushnak the Ponderer!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Who the devil is Yushnak the Ponderer?"
        [/message]
        [message]
            speaker=Clammie
            message= _ "That is a long story. --Our tribe has had reasonably good relations with Hammerhead Clan and some of their smaller rivals. Once they see us on wolfback, it can only improve their respect for us. On to the Hammerheads!"
        [/message]
        [message]
            speaker=Kennison
            message= _ "Along the way, could someone tell me about Yushnak the Ponderer?"
        [/message]
        [message]
            speaker=Eeep
            message= _ "<i>spits</i>"
        [/message]

        {CLEAR_VARIABLE door,clammie_experience,seven_bones,altar_glimmers,Key_is_found,touched_bones,unstoned_bone,Xaztex_allied,stored_clammie,no_repeating,spear_picked_up,spear_picked_up2,Xaz_gone}

        [endlevel]
            result=victory
        [/endlevel]
    [/event]

    # on death of Clammie
    [event]
        name=last breath
        [filter]
            id=Clammie
        [/filter]

        [message]
            speaker=Clammie
            message= _ "I should have put more thought into this."
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # on death of Misris
    [event]
        name=last breath
        [filter]
            id=Misris
        [/filter]

        {MODIFY_UNIT id=Misris profile "portraits/transparent/misris-night.png"}

        [message]
            speaker=Misris
            message= _ "Eeep, my love! Please find the courage to continue without me."
        [/message]
        [message]
            speaker=Eeep
            message= _ "I will try, dear Misris, but it will not be easy."
        [/message]

        {VARIABLE Misris_is_dead yes}
    [/event]

    # on death of Eeep
    [event]
        name=die
        [filter]
            id=Eeep
        [/filter]

        [message]
            speaker=Clammie
            message= _ "Truly, we cannot continue without Eeep!"
        [/message]

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Kennison's death
    [event]
        name=last breath
        [filter]
            id=Kennison
        [/filter]
        [message]
            speaker=Kennison
            message= _ "Rapscallion!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Multispear Guardian's death
    [event]
        name=last breath
        [filter]
            id=Guardian
        [/filter]
        [if]
            [have_unit]
                id=$id_of_spearholder
            [/have_unit]
            [then]
                [message]
                    speaker=Guardian
                    message= _ "$name_of_spearholder the daring, you have proven yourself worthy of the multi spear, in spite of your appearance. I pass on now to the next plane."
                [/message]
                [message]
                    speaker=$id_of_spearholder
                    message= _ "I will not be missing you."
                [/message]
                [message]
                    speaker=Guardian
                    message= _ "Most of those burns should heal in a few months. Again, farewell!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Guardian
                    message= _ "I pass on now to the next plane. No warrior here is worthy of the great multi spear!"
                [/message]
            [/else]
        [/if]
    [/event]

	# Remove team 3 from status table when defeated:
    [event]
        name=new_turn
        first_time_only=no

		{IF_DEAD 3 (
			[modify_side]
	            [filter_side]
	            	side=3
	            [/filter_side]
	            hidden=yes
	        [/modify_side]
	    )}
    [/event]

	# Remove team 5 from status table when defeated:
    [event]
        name=new_turn
        first_time_only=no

		{IF_DEAD 5 (
			[modify_side]
	            [filter_side]
	            	side=5
	            [/filter_side]
	            hidden=yes
	        [/modify_side]
	    )}
    [/event]

    # Xaztex shouldn't die no matter what:
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=Xaztex
        [/filter]

        [message]
            speaker=Xaztex
            message= _ "One such as myself is not so easily dispatched!"
        [/message]

        {STORE_UNIT_VAR id=Xaztex x xaztex_x}
        {STORE_UNIT_VAR id=Xaztex y xaztex_y}

        # it's weird to kill him, but we need his hex immediately:
        [kill]
            id=Xaztex
            animate=no
            fire_event=no
        [/kill]

        [sound]
            name=wail.wav
        [/sound]

        {UNIT 4 Spectre $xaztex_x $xaztex_y (
            profile=portraits/undead/transparent/ghost.png
            id=Xaztex
            name= _ "Xaztex"
            unrenamable=yes
            canrecruit=yes
            animate=yes
        )}

        {CLEAR_VARIABLE xaztex_x,xaztex_y}
    [/event]

    # Reed's death
    [event]
        name=last breath
        [filter]
            id=Reed
        [/filter]

        {VARIABLE Reed_is_dead yes}

        [message]
            speaker=Reed
            message=_"Farewell, my friends! Clammie, I never knew freedom until I met you."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Rest well, loyal goblin!"
        [/message]
    [/event]

    {BONES_DEATHS}
    {HERO_DEATHS}
[/scenario]

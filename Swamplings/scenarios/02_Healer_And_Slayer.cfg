#textdomain wesnoth-Swamplings

[scenario]
    id=02_Healer_And_Slayer
    name= _ "Healer And Slayer"
    map_data="{~add-ons/Swamplings/maps/Ronrys01.map}"
    {SCENARIO_MUSIC "breaking_the_chains.ogg"}
    turns=33
    victory_when_enemies_defeated=no

    {STARTING_VILLAGES_AREA 1 15 3 10}

    {DEFAULT_SCHEDULE}

    next_scenario=03_Exodus

    [side]
        type=Goblin Rouser Sw
        id=Clammie
        name= _ "Clammie"
        unrenamable=yes
        side=1
        canrecruit=yes
        team_name=1
        user_team_name=_"Clammie and Co."
        controller=human
        {GOLD 100 50 0}
        [modifications]
            {TRAIT_SWAMPSAVVY}
        [/modifications]
        shroud=yes
        shroud_data="{~add-ons/Swamplings/maps/Ronrys01_Shroud.shroud}"
         # this line seems to get ignored:
        animate=yes
       # this line seems to get ignored:
        facing=sw
    [/side]

    [side]
        no_leader=yes
        side=2
        team_name=2
        user_team_name=_"Wild Things"
        [ai]
            caution=0.0
            aggression=0.9
        [/ai]
        income=-2
        {GOLD 0 0 0}
    [/side]

    # for Rashki:
    [side]
        no_leader=yes
        side=3
        team_name=3
        user_team_name=_"Rashki"
        hidden=yes
        {GOLD 0 0 0}
    [/side]

    [item]
        x,y=21,5
        image=scenery/leanto.png
    [/item]

    [story]
        [part]
            music="data/add-ons/Swamplings/music/nr-sad.ogg"
            story= _ "My heart ached for Terro, but I could not discuss it with the healer. What would a human know of the love between father and son?"
            background="maps/wesnoth.png"
            show_title=yes
            title_alignment=center
        [/part]
    [/story]

    [event]
        name=prestart

		# pick random number to determine location of shed:
        [set_variable]
            name=shed
            rand=0..4
        [/set_variable]

        # randomly pick shed location
        [store_locations]
            variable=shedpos
            x=5,8,20,21,21
            y=2,3, 6, 5, 1
        [/store_locations]

        #{DEBUG_MSG "shed is at $shedpos[$shed].x $shedpos[$shed].y"}

        # this variable establishes that we haven't gotten Ronry's advice yet:
        {VARIABLE advice_from_Ronry no}

        {MODIFY_UNIT id=Clammie facing sw}

    [/event]

    [event]
        name=start

        [unit]
            type=White Mage
            id=Ronry
            name= _ "Ronry"
            unrenamable=yes
            side=1
            gender=male
            facing=se
            animate=yes
            x,y=12,7
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        {MODIFY_UNIT id=Ronry facing se}

        [message]
            speaker=Clammie
            message= _ "… then they just started attacking for no reason. I don't know why they came into the bog. What do they want?"
        [/message]
        [message]
            speaker=Ronry
            message= _ "You said they were looking for a slayer. So the question is, why did the slayer come here. And that is a question I can answer. For years I've been refining different poisons."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Why are you interested in poisons?"
        [/message]
        [message]
            speaker=Ronry
            message= _ "Many poisons also have curative powers. Perhaps I can find the one that will cure these old bones of mine. But we must discuss our defense. These are dangerous foes."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Humans are the worst! I meant–"
        [/message]
        [message]
            speaker=Ronry
            message= _ "No offense taken, my friend."
        [/message]
        [message]
            speaker=Clammie
            message= _ "My tribe is leaving the home patch for now. It's impossible to defend against these horsemen. Ronry, I grant you full rights to scavenge whatever you want from our midden heap. It's the legacy of three generations of my people."
        [/message]
        [message]
            speaker=Ronry
            message= _ "That's very kind. I have a gift for you too, a bat house. Don't open it until I –-"
        [/message]

        [item]
            x,y=13,8
            image=items/chest.png
        [/item]

        [sound]
            name=open-chest.wav
        [/sound]

		{GENERIC_UNIT 2 "Vampire Bat" 13 8}

        [sound]
            name=bat-flapping.wav
        [/sound]

        [move_unit]
            type=Vampire Bat
            to_x=13,12,11,22
            to_y= 8,13,19,22
        [/move_unit]

		[kill]
			type=Vampire Bat
		[/kill]

        [message]
            speaker=Clammie
            message= _ "This is amazing! A bat of my very own!"
        [/message]
        [message]
            speaker=Ronry
            message= _ "Yes ..."
        [/message]
        [message]
            speaker=Clammie
            message= _ "When does he come back?"
        [/message]
        [message]
            speaker=Ronry
            message= _ "Seeing as it's completely untrained, I doubt it ever will."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Oh ..."
        [/message]
        [message]
            speaker=Ronry
            message= _ "Perhaps a trained bat would have been more useful. I'll introduce you to one of mine. He's very tame."
        [/message]

        [move_unit_fake]
            type=Vampire Bat
            side=1
            x=12,13,14
            y=8,10,8
        [/move_unit_fake]

        [unit]
            type=Vampire Bat
            id=Nosferatu
            name= _ "Nosferatu"
            unrenamable=yes
            x,y=14,8
            side=1
#ifdef EASY
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_LOYAL}
#endif
        [/unit]

        # Nos attacks Clammie
        [animate_unit]
            flag=attack
            with_bars=no
            [filter]
                id=Nosferatu
            [/filter]
            [primary_attack]
                name=fangs
            [/primary_attack]
            hits=yes
            [facing]
                [filter]
                    id=Clammie
                [/filter]
            [/facing]
            [animate]
                flag=defend
                [filter]
                    id=Clammie
                [/filter]
                with_bars=no
                [facing]
                    [filter]
                        id=Nosferatu
                    [/filter]
                [/facing]
                hits=yes
            [/animate]
        [/animate_unit]

        # Clammie is hurt.
        [store_unit]
            [filter]
                id=Clammie
            [/filter]
            variable=stored_clammie
        [/store_unit]

        {VARIABLE_OP stored_clammie.hitpoints add -4}

        [unstore_unit]
            variable=stored_clammie
            find_vacant=no
            text= _ "4"
            {COLOR_HARM}
        [/unstore_unit]

        [redraw]
        [/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Nosferatu
            message= _ "iiiiiii!"
        [/message]
        [message]
            speaker=Ronry
            message= _ "Nosferatu! That's very impolite."
        [/message]
        [message]
            speaker=Clammie
            message= _ "Ronry, can you teach me to train bats myself?"
        [/message]
        [message]
            speaker=Ronry
            message= _ "I will teach you as I was taught. Here's a wand, Clammie. You can use it to charm bats."
        [/message]
        [message]
            speaker=narrator
            image="wesnoth-icon.png"
            message= _ "Ronry gives you a very plain wand. Actually, it looks like a stick. You imagine great power must circulate through it."
        [/message]

        [object]
            [filter]
                id=Clammie
            [/filter]
            name= _ "Wand of Wonderment"
            image=attacks/javelin-orcish.png
            duration=level
            # I really thought this line was hilarious, for about a minute:
            #	description= _ "What a worthy wooden wand, wonderfully worn!"
            [effect]
                apply_to=new_attack
                name=staff
                description= _ "Wand of Wonderment"
                icon=attacks/javelin-orcish.png
                type=impact
                range=melee
                damage=6
                number=2
            [/effect]
        [/object]

        {CHARM (id=Clammie) (staff)}

        # storing Nos and killing him, then unstoring him in the cave somehow creates a unit that can't gain XP, so I'm killing him here and will bring him back with unit tag later.
        [kill]
            id=Nosferatu
        [/kill]

        [move_unit_fake]
            type=Vampire Bat
            side=1
            x=14,11,16
            y=8,19,19
        [/move_unit_fake]

        [message]
            speaker=Ronry
            message= _ "Follow Nosferatu to where the other bats are, and see how many you can charm."
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Charm five bats"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Clammie"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Ronry"
                condition=lose
            [/objective]
            [objective]
                description= _ "Turns run out"
                condition=lose
            [/objective]
            note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
        [/objectives]
    [/event]

    # wild bat appears when Clammie enters cave
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Clammie
            x=12-13
            y=20-21
        [/filter]

        [unit]
            type=Vampire Bat
            id=Nosferatu
            name= _ "Nosferatu"
            unrenamable=yes
            x,y=17,21
            side=1
#ifdef EASY
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
            {IS_LOYAL}
#endif
        [/unit]

        # here is our first wild bat:
        {UNIT 2 "Vampire Bat" 22 22 (facing=nw)}
        {VARIABLE chapter 2}
    [/event]

    [event]
        name=side 2 turn
        first_time_only=no
        [if]
            [have_unit]
                side=1
                type=Vampire Bat
                count=2
            [/have_unit]

			# in case you've already managed to get Nosferatu killed:
			[or]
                [not]
                    [have_unit]
                        id=Nosferatu
                    [/have_unit]
                [/not]

	            [have_unit]
	                side=1
	                type=Vampire Bat
	                count=1
	            [/have_unit]
			[/or]

            [then]
                [if]
                    [variable]
                        name=hesaidthis
                        not_equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Clammie
                            message= _ "I did it! Ronry, I charmed a bat!"
                        [/message]
                        [message]
                            speaker=Ronry
                            message= _ "I sensed you might have a skill for this."
                        [/message]
                        [message]
                            speaker=Clammie
                            message= _ "Are there any more in here?"
                        [/message]
                        [message]
                            speaker=Ronry
                            message= _ "I would think there would be quite a few."
                        [/message]

                        {VARIABLE hesaidthis yes}

                        {UNIT 2 "Vampire Bat" 22 22 (facing=nw)}
                        {UNIT 2 "Vampire Bat" 1 16 (facing=se)}

#ifdef HARD
                        {UNIT 2 "Vampire Bat" 5 15 (facing=sw)}
#endif
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    # fresh bats, if there are none left to charm
    [event]
        name=new turn
        first_time_only=no
        [if]
            [variable]
                name=chapter
                equals=2
            [/variable]
            [then]
                {IF_DEAD 2 (
                    {UNIT 2 "Vampire Bat" 22 22 (facing=nw)}
                    {UNIT 2 "Vampire Bat" 1 16 (facing=se)}
#ifdef HARD
                    {UNIT 2 "Vampire Bat" 5 15 (facing=sw)}
#endif
                )}
            [/then]
        [/if]
    [/event]

    # a dead-bat-counter:
    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=2
        [/filter]

        {VARIABLE_OP Clammie_killed add 1}
    [/event]

    [event]
        name=new turn
        first_time_only=no

        # advice from Ronry if you keep killing bats. This is here for players who mistake the Wand of Wonderment for a plague staff and start trying to charm bats after nearly killing them with the spear. This results in a dead bat, not a charmed bat, and is not fun, so Ronry will give advice after you've killed three bats and charmed none:
        [if]
            [variable]
                name=chapter
                equals=2
            [/variable]
            [then]
                {IF_VAR advice_from_Ronry not_equals yes (
                    [then]
                        {IF_VAR Clammie_killed equals 3 (
                            [then]
                                [if]
                                    [not]
                                        [have_unit]
                                            id=Nosferatu
                                        [/have_unit]
                                    [/not]
#                                    [and]
                                        [not]
                                            [have_unit]
                                                side=1
                                                race=bats
                                                count=1
                                            [/have_unit]
                                        [/not]
#                                    [/and]
                                    [or]
                                        [have_unit]
                                            id=Nosferatu
                                        [/have_unit]
#                                        [and]
                                            [have_unit]
                                                side=1
                                                race=bats
                                                count=1
                                            [/have_unit]
#                                        [/and]
                                    [/or]
                                    [then]
                                        [message]
                                            speaker=Ronry
                                            message= _ "This is going to take a long time if you keep killing bats."
                                        [/message]
                                        [message]
                                            speaker=Clammie
                                            message= _ "How do you work this thing? You didn't really explain it."
                                        [/message]
                                        [message]
                                            speaker=Ronry
                                            message= _ "Just poke at them with the Wand of Wonderment. But not too hard."
                                        [/message]
                                        [message]
                                            speaker=Clammie
                                            message=_"<i>crazy human!</i>"
                                        [/message]
                                        [message]
                                            speaker=Ronry
                                            message=_"<i>crazy goblin!</i>"
                                        [/message]

                                        {VARIABLE advice_from_Ronry yes}
                                    [/then]
                                [/if]
                            [/then]
                        )}
                    [/then]
                )}
            [/then]
        [/if]
    [/event]

    # what happens after you charm 5 bats:
    [event]
		# using ai turn so a newly charmed bat isn't killed before it's counted:
        name=ai turn
        first_time_only=no

		# this variable counts the number of bats:
		[store_unit]
			variable=bat_num
			[filter]
				race=bats
				side=1
				[not]
				    id=Nosferatu
				[/not]
			[/filter]
		[/store_unit]

        [if]
			[variable]
				name=bat_num.length
				greater_than_equal_to=5
			[/variable]

           [then]
                [if]
                    [variable]
                        name=chapter
                        equals=2
                    [/variable]
                    [then]
                        [message]
                            speaker=narrator
                            image="wesnoth-icon.png"
                            message= _ "You can now recruit vampire bats!"
                        [/message]

                        [set_recruit]
                            recruit=Vampire Bat
                        [/set_recruit]

                        [message]
                            speaker=Clammie
                            message= _ "And I thought this magic wand was just a stick!"
                        [/message]
                        [message]
                            speaker=Ronry
                            message= _ "It is just a stick. Let's go."
                        [/message]

						# restore bat movements, number of attacks & full heal:
						{FULL_HEAL race=bats}

						[store_unit]
                            [filter]
                                race=bats
                                side=1
                            [/filter]
                            variable=all_bats
                        [/store_unit]

				        {FOREACH all_bats i}
							{VARIABLE all_bats[$i].moves $all_bats[$i].max_moves}
		                    {VARIABLE all_bats[$i].attacks_left $all_bats[$i].max_attacks}
				        {NEXT i}

                        # heal Ronry & Clammie:
#ifdef EASY
                        [message]
                            speaker=narrator
                            image="wesnoth-icon.png"
                            message= _ "Ronry quaffs a healing potion."
                            sound=potion.ogg
                        [/message]
                        {FULL_HEAL id=Ronry}
                        [sound]
                            name=heal.wav
                        [/sound]
                        [redraw]
                        [/redraw]

                        [store_unit]
                            [filter]
                                id=Clammie
                            [/filter]
                            variable=stored_clammie
                        [/store_unit]
                        {IF_VAR stored_clammie.hitpoints less_than 30 (
                            [then]
                                [message]
                                    speaker=narrator
                                    image="wesnoth-icon.png"
                                    message= _ "Ronry gives you a healing potion."
                                    sound=potion.ogg
                                [/message]
                                {FULL_HEAL id=Clammie}
                                [sound]
                                    name=heal.wav
                                [/sound]
                                [redraw]
                                [/redraw]
                            [/then]
                        )}
#endif

#ifdef NORMAL
                        [store_unit]
                            [filter]
                                id=Ronry
                            [/filter]
                            variable=stored_ronry
                        [/store_unit]
                        {IF_VAR stored_ronry.hitpoints less_than 20 (
                            [then]
                                [message]
                                    speaker=narrator
                                    image="wesnoth-icon.png"
                                    message= _ "Ronry quaffs a healing potion."
                                    sound=potion.ogg
                                [/message]
                                [kill]
                                    id=Ronry
                                    fire_event=no
                                [/kill]
                                {VARIABLE_OP stored_ronry.hitpoints add 15}
                                [sound]
                                    name=heal.wav
                                [/sound]
                                [unstore_unit]
                                    variable=stored_ronry
                                    find_vacant=yes
                                [/unstore_unit]
                                [redraw]
                                [/redraw]
                            [/then]
                        )}
#endif

                        {VARIABLE chapter 3}

				        [kill]
				            side=2
				        [/kill]

						[end_turn]
						[/end_turn]
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    [event]
        name=new_turn
        first_time_only=no
        
        {IF_VAR chapter equals 3 (
        	[then]
		        [unit]
		            type=Assassin
		            id=Rashki
		            name= _ "Rashki"
		            unrenamable=yes
		            side=3
		            gender=male
		            x,y=13,2
		            facing=se
		        [/unit]

		        [store_unit]
		            [filter]
		                id=Ronry
		            [/filter]
		            variable=stored_ronry
		        [/store_unit]

		        {MOVE_UNIT (id=Ronry) 14 2}
		        {MODIFY_UNIT (id=Ronry) facing nw}

		        {MOVE_UNIT (id=Clammie) 15 3}
		        {MODIFY_UNIT (id=Clammie) facing nw}

		        # put bats in bat house
		        {FOREACH all_bats i}

					{MOVE_UNIT x,y=$all_bats[$i].x,$all_bats[$i].y 13 8}

					[kill]
						x,y=13,8
					[/kill]

		        {NEXT i}

		        [sound]
		            name=bat-flapping.wav
		        [/sound]

		        {REPLACE_SCENARIO_MUSIC revelation.ogg}

		        [message]
		            speaker=Rashki
		            message= _ "Are you the one they call Ronry?"
		        [/message]
		        [message]
		            speaker=Ronry
		            message= _ "Who is it that asks?"
		        [/message]
		        [message]
		            speaker=Rashki
		            message= _ "My name is Rashki. I understand you have a powerful toxin for sale. The drop of death."
		        [/message]
		        [message]
		            speaker=Ronry
		            message= _ "No, it's not for sale. The poison I discovered shall only be used for good purposes, not evil."
		        [/message]
		        [message]
		            speaker=Rashki
		            message= _ "But I only wish to kill evil creatures!"
		        [/message]
		        [message]
		            speaker=Ronry
		            message= _ "The drop of death shall not be bought and sold like a market trinket! If I sold it for ten gold pieces, what would stop you from selling to another for twenty? Am I to trust you, and all other men who buy it, when I can barely trust myself with its power?"
		        [/message]
		        [message]
		            speaker=Rashki
		            message= _ "If you will not accept my gold, you will take my blades."
		        [/message]

		        # Rashki attacks Ronry
		        [animate_unit]
		            flag=attack
		            with_bars=no
		            [filter]
		                id=Rashki
		            [/filter]
		            [primary_attack]
		                name=knife
		            [/primary_attack]
		            hits=yes
		            [facing]
		                [filter]
		                    id=Ronry
		                [/filter]
		            [/facing]
		            [animate]
		                flag=defend
		                [filter_second]
		                    id=Ronry
		                [/filter_second]
		                hits=yes
		                with_bars=no
		            [/animate]
		        [/animate_unit]

		        # Ronry is poisoned
		        [store_unit]
		            [filter]
		                id=Ronry
		            [/filter]
		            variable=stored_ronry
		            kill=yes
		        [/store_unit]

		        [set_variable]
		            name=stored_ronry.status.poisoned
		            value="true"
		        [/set_variable]
		        [set_variable]
		            name=stored_ronry.status.petrified
		            value="true"
		        [/set_variable]

		        [unstore_unit]
		            variable=stored_ronry
		            find_vacant=yes
		        [/unstore_unit]
		        [redraw]
		        [/redraw]

		        {MOVE_UNIT (id=Rashki) 11 1}

		        [store_unit]
		            [filter]
		                id=Rashki
		            [/filter]
		            variable=stored_rashki
		            kill=yes
		        [/store_unit]

		        [message]
		            speaker=Ronry
		            message= _ "Paralyzing poison! Clammie, quickly go to the shed and unlock the cabinet .. I need the green bottle immediately!"
		        [/message]

		        [objectives]
		            summary= _ "New Objectives:"
		            side=1
		            [objective]
		                description= _ "Get antidote for Ronry before he dies"
		                condition=win
		            [/objective]
		            [objective]
		                description= _ "Death of Clammie"
		                condition=lose
		            [/objective]
		            [objective]
		                description= _ "Death of Ronry"
		                condition=lose
		            [/objective]
		            [objective]
		                description= _ "Turns run out"
		                condition=lose
		            [/objective]
		            note= _ "Search the nearby area. WARNING: Ronry can be killed by this poison! "+{EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
		        [/objectives]

		        # in Hard games, Ronry will be dead in 8 turns, so add 10 turns to current turn number:
		        {VARIABLE turns 10}
		        {VARIABLE_OP turns add $turn_number}

		        [modify_turns]
		            value=$turns
		        [/modify_turns]

				{VARIABLE chapter 4}

        	[/then]
		)}
    [/event]

    # unfortunately, poison doesn't affect you if you're petrified, so:
    [event]
        name=turn refresh
        first_time_only=no
        [if]
            [variable]
                name=chapter
                equals=4
            [/variable]
#            [and]
                [variable]
                    name=side_number
                    numerical_equals=1
                [/variable]
#            [/and]
            [then]
                [store_unit]
                    [filter]
                        id=Ronry
                    [/filter]
                    variable=stored_ronry
                    kill=yes
                [/store_unit]

                # poison is more potent on higher levels
#ifdef HARD
                {VARIABLE_OP stored_ronry.hitpoints add -6}
                [unstore_unit]
                    variable=stored_ronry
                    find_vacant=yes
                    text= _ "6"
                    {COLOR_HARM}
                [/unstore_unit]
#endif
#ifdef NORMAL
                {VARIABLE_OP stored_ronry.hitpoints add -4}
                [unstore_unit]
                    variable=stored_ronry
                    find_vacant=yes
                    text= _ "4"
                    {COLOR_HARM}
                [/unstore_unit]
#endif
#ifdef EASY
                {VARIABLE_OP stored_ronry.hitpoints add -2}
                [unstore_unit]
                    variable=stored_ronry
                    find_vacant=yes
                    text= _ "2"
                    {COLOR_HARM}
                [/unstore_unit]
#endif

                [sound]
                    name=poison.ogg
                [/sound]

                [redraw]
                [/redraw]

                {IF_VAR stored_ronry.hitpoints less_than_equal_to 0 (
                    [then]
                        [kill]
                            id=Ronry
                            fire_event=yes
                        [/kill]
                    [/then]
                )}
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Clammie
            x=$shedpos[$shed].x
            y=$shedpos[$shed].y
        [/filter]
        [if]
            [variable]
                name=chapter
                equals=4
            [/variable]
            [then]
                [message]
                    speaker=Clammie
                    message= _ "I wonder if this is it."
                [/message]
                [object]
                    name= _ "Cabinet"
                    image=items/chest-plain-closed.png
                    duration=level
                    description= _ "A locked cabinet."
                [/object]

                [message]
                    speaker=Clammie
                    message= _ "But where is the key?"
                [/message]
                [message]
                    speaker=Ronry
                    message= _ "Hurry, Clammie!"
                [/message]

                {MOVE_UNIT (id=Clammie) 16 2}

                [item]
                    x,y=17,2
                    image=items/chest-plain-closed.png
                [/item]

                [message]
                    speaker=Ronry
                    message= _ "The green bottle! Hurry!"
                [/message]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "With little time left, you break open the cabinet."
                [/message]

                [remove_item]
                    x,y=17,2
                    image=items/chest-plain-closed.png
                [/remove_item]
                [sound]
                    name=fist.ogg
                [/sound]
                [item]
                    x,y=17,2
                    image=items/chest-plain-open.png
                [/item]

                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "Which potion do you pick?"
                    [option]
                        message= _ "&items/potion-grey.png=This?"
                    [/option]
                    [option]
                        message= _ "&items/potion-grey.png=This?"
                    [/option]
                    [option]
                        image=items/potion-grey.png
                        message= _ "&items/potion-grey.png=This?"
                    [/option]
                [/message]
                [message]
                    speaker=Ronry
                    message= _ "I've forgotten, goblins can't see colors! This is surely the end!"
                [/message]
                [message]
                    speaker=Clammie
                    message= _ "One smells of duckweed, the next of cattail and bromeliad. The third of milkweed."
                [/message]
                [message]
                    speaker=Ronry
                    message= _ "Yes, the milkweed! Quickly!"
                [/message]

                # show potion & give it to Clammie
                [object]
                    [filter]
                        id=Clammie
                    [/filter]
                    name= _ "Healer Ointment"
                    image=items/potion-green.png
                    duration=level
                    description= _ "This ointment has amazing curative powers! Uncorking the bottle is unnecessary. It even heals nearby allies."
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_CURES}
                            {ABILITY_REGENERATES}
                        [/abilities]
                        description= _ "Healer Ointment"
                        icon=items/potion-green.png
                    [/effect]
                [/object]

                [message]
                    speaker=Clammie
                    message= _ "I feel great power radiating from this bottle! Ronry, what on earth is this made from?"
                [/message]

                [kill]
                    id=Ronry
                    animate=yes
                    fire_event=no
                [/kill]

                [unstore_unit]
                    [filter]
                        id=Rashki
                        x,y=9,1
                    [/filter]
                    variable=stored_rashki
                [/unstore_unit]

                {MOVE_UNIT (id=Rashki) 15 2}

                [message]
                    speaker=Rashki
                    message= _ "Very wise, little goblin. You almost saved his life. Is that the death drop in your hands?"
                [/message]

                {MOVE_UNIT (id=Clammie) 16 3}
                {MOVE_UNIT (id=Rashki) 15 3}
		        {MODIFY_UNIT id=Clammie facing nw}

                [message]
                    speaker=Clammie
                    message= _ "You have killed the only one who can answer your questions, wise Rashki."
                [/message]

                {MOVE_UNIT (id=Clammie) 15 5}
                {MOVE_UNIT (id=Rashki) 15 4}

                [message]
                    speaker=Rashki
                    message= _ "Then let us experiment."
                [/message]
                [message]
                    speaker=narrator
                    image="wesnoth-icon.png"
                    message= _ "Rashki dips his dagger in the bottle and then slashes you!"
                [/message]

                # Rashki attacks Clammie
                [animate_unit]
                    flag=attack
                    with_bars=no
                    [filter]
                        id=Rashki
                    [/filter]
                    [primary_attack]
                        name=dagger
                    [/primary_attack]
                    hits=yes
                    [facing]
                        [filter]
                            id=Clammie
                        [/filter]
                    [/facing]
                    [animate]
                        flag=defend
                        [filter]
                            id=Clammie
                        [/filter]
                        with_bars=no
                        [facing]
                            [filter]
                                id=Rashki
                            [/filter]
                        [/facing]
                        hits=yes
                    [/animate]
                [/animate_unit]

                # Clammie is hurt.
                [store_unit]
                    [filter]
                        id=Clammie
                    [/filter]
                    variable=stored_clammie
                [/store_unit]

                {VARIABLE_OP stored_clammie.hitpoints add -4}

                [unstore_unit]
                    variable=stored_clammie
                    find_vacant=no
                    text= _ "4"
                    {COLOR_HARM}
                [/unstore_unit]

                {CLEAR_VARIABLE stored_clammie}

                [redraw]
                [/redraw]

                [delay]
                    time=1000
                [/delay]

                [message]
                    speaker=Rashki
                    message= _ "You're not dead, therefore it's not what I'm after. Where did you find this bottle?"
                [/message]

                {MOVE_UNIT (id=Clammie) 12 8}
                {MODIFY_UNIT (id=Clammie) facing ne}

                [message]
                    speaker=Clammie
                    message= _ "In the box over here."
                [/message]

                {MOVE_UNIT (id=Rashki) 13 8}

                [scroll_to_unit]
                    id=Rashki
                [/scroll_to_unit]

                [sound]
                    name=open-chest.wav
                [/sound]

                [sound]
                    name=bat-flapping.wav
                [/sound]

                [modify_side]
                    side=3
                    hidden=no
                [/modify_side]

                {FOREACH all_bats i}
                    # todo: fix these parameters to avoid console errors
                    {VARIABLE all_bats[$i].goto_x 0}
                    {VARIABLE all_bats[$i].goto_y 0}
                    # Let the bats out!
                    [unstore_unit]
                        variable=all_bats[$i]
                        x,y=13,8
                        find_vacant=yes
                    [/unstore_unit]
                {NEXT i}

				[redraw]
				[/redraw]

                [message]
                    speaker=Rashki
                    message= _ "!"
                [/message]

                [modify_side]
                    side=2
                    hidden=yes
                [/modify_side]

                [modify_side]
                    side=3
                    hidden=no
                [/modify_side]

                # add 7 more turns to turn limit:
                {VARIABLE turns 7}
                {VARIABLE_OP turns add $turn_number}

                [modify_turns]
                    value=$turns
                [/modify_turns]

                {VARIABLE chapter 5}

                [objectives]
                    summary= _ "New Objectives:"
                    side=1
                    [objective]
                        description= _ "Defeat Rashki"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "Death of Clammie"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Turns run out"
                        condition=lose
                    [/objective]
                    note={EARLY_FINISH_BONUS_NOTE}+{NEW_GOLD_CARRYOVER_NOTE_40}
                [/objectives]
            [/then]
        [/if]
    [/event]

    [event]
        name=attacker hits
        [filter_second]
            id=Ronry
        [/filter_second]
        [message]
            speaker=Ronry
            message= _ "There's one with teeth!"
        [/message]
    [/event]

    # on death of Clammie
    [event]
        name=last breath
        [filter]
            id=Clammie
        [/filter]
        [message]
            speaker=Clammie
            message= _ "But there is so much more--"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Ronry
        [/filter]
        [message]
            speaker=Ronry
            message= _ "Ah! What an absurd way to die!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # out of time:
    [event]
        name=time over
        [message]
            speaker=Clammie
            message= _ "Out of time!"
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Rashki
        [/filter]
        [message]
            speaker=Rashki
            message= _ "Undone by a lowly swamp goblin and his pet bats! I never laid eyes on the damned death drops, but I am surely their first victim!"
        [/message]
        [message]
            speaker=Clammie
            message= _ "You miscount, wise slayer."
        [/message]

        [kill]
            id=Rashki
            animate=yes
        [/kill]

        {CLEAR_VARIABLE hesaidthis,chapter,shed,shedpos,stored_ronry,stored_rashki,Clammie_killed,advice_from_Ronry,turns,bat_num,all_bats,side_2_units_charmed}

        [endlevel]
            result=victory
            bonus=yes
            {NEW_GOLD_CARRYOVER 40}
        [/endlevel]
    [/event]
[/scenario]
